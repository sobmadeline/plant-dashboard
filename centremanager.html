<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="./images/favicon.ico">
  <title>Centre Management - BRAC Tools</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pindan: "#C54B00",
            darkturq: "#004153",
            bg: "#07141a",
            card: "#0b2028",
            line: "#14313b",
            muted: "#cbd5e1",
            good: "#15803d",
            warn: "#ca8a04",
            bad: "#b91c1c",
            plan: "#2563eb",
            teal: "#0f766e"
          }
        }
      }
    }
  </script>

  <script>
    (async function guard(){
    try{
      const res = await fetch('/api/whoami.php', { cache: 'no-store' });
      if (!res.ok) throw new Error('not logged in');
    } catch(e){
      const next = encodeURIComponent(location.pathname + location.search + location.hash);
      location.href = `/login.html?next=${next}`;
    }
    })();
  </script>

  <!-- Tiny shim to preserve your existing JS class toggles -->
  <style>
    .tab.active{ border-color:#C54B00 !important; box-shadow:0 0 0 2px rgba(197,75,0,.35) !important; }
    .btn.selected{ outline:3px solid #f8fafc; box-shadow:0 0 0 3px rgba(197,75,0,.55); }
  </style>
</head>

  <body class="m-0 font-sans bg-bg text-slate-50">

  <div id="logoutOverlay" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center">
    <div class="bg-card border border-line rounded-2xl p-6 w-[360px]">
      <div id="logoutOverlayTitle" class="font-black text-xl mb-2">Session</div>
      <div id="logoutOverlayMsg" class="text-sm text-muted mb-4"></div>
      <button id="logoutOverlayBtn" class="w-full py-2 rounded bg-plan font-black">OK</button>
    </div>
  </div>

  
  <!-- Header -->
  <header class="bg-darkturq px-4 py-3.5 flex items-center gap-3">
   <a href="index" class="max-h-10 max-w-[211px] rounded-xl text-white flex items-center justify-center font-black tracking-wide">
     <img src="./images/WhiteWebsiteLogo.png" alt="BRAC Logo" class="object-contain" />
   </a>
    <div>
      <div class="text-[18px] font-black leading-tight">Centre Manager</div>
      <div class="text-[13px] opacity-85 mt-0.5">Broome Recreation and Aquatic Centre</div>
    </div>
    <div class="flex items-center gap-3">
      <span id="whoami" class="text-white/90 text-sm font-semibold"></span>
      <button id="logoutBtn"
        class="px-4 py-2 rounded-xl bg-white/90 text-slate-900 font-bold hover:bg-white">
        Logout
      </button>
    </div>

      <script>
      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try {
          await fetch('/api/logout.php', { method: 'POST' });
        } catch {}
        location.href = '/login.html';
      });
      </script>

      <script>
      (async function initUser(){
        try {
          const res = await fetch('/api/whoami.php', { cache:'no-store' });
          if (res.ok) {
            const j = await res.json();
            document.getElementById('whoami').textContent = j.user.display_name;
          }
        } catch {}
      })();

      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try { await fetch('/api/logout.php', { method: 'POST' }); } catch {}
        location.href = '/login.html';
      });
      </script>

  </header>

  <!-- Tabs -->
  <div class="flex gap-2.5 px-3.5 py-2.5 bg-[#06181f]">
    <button class="tab active flex-1 rounded-2xl border border-line bg-card px-3 py-3 font-black text-base"
      id="btnUpdate" type="button" onclick="switchTab('update')">Plant Status Update</button>

    <button class="tab flex-1 rounded-2xl border border-line bg-card px-3 py-3 font-black text-base"
      id="btnHandover" type="button" onclick="switchTab('handover')">DM Handover</button>

    <button class="tab flex-1 rounded-2xl border border-line bg-card px-3 py-3 font-black text-base"
      id="btnChemical" type="button" onclick="switchTab('chemical')">Chemical Calculations</button>

    <button class="tab flex-1 rounded-2xl border border-line bg-card px-3 py-3 font-black text-base"
      id="btnNotices" type="button" onclick="switchTab('notices')">Noticeboard Manager</button>
  </div>

  <!-- UPDATE TAB -->
  <div id="tab-update" class="px-3.5 pt-3.5 pb-5">
    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base">Quick Update</div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Component</label>
      <select id="component" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base"></select>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-2">Status</label>
      <div class="grid grid-cols-2 gap-2.5 mt-2.5" id="statusButtons">
        <button class="btn rounded-2xl px-3 py-3 font-black text-white bg-good" type="button" data-status="Operational">Operational</button>
        <button class="btn rounded-2xl px-3 py-3 font-black text-white bg-warn" type="button" data-status="Degraded">Degraded</button>
        <button class="btn rounded-2xl px-3 py-3 font-black text-white bg-bad" type="button" data-status="Offline">Offline</button>
        <button class="btn rounded-2xl px-3 py-3 font-black text-white bg-plan" type="button" data-status="Planned Maintenance">Planned</button>
      </div>

      <div class="text-xs font-extrabold text-muted mt-2" id="chosenStatus">Selected status: —</div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Condition</label>
      <select id="condition" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base">
        <option value="">(optional)</option>
        <option>Normal</option>
        <option>Noise / Vibration</option>
        <option>Reduced Flow</option>
        <option>Pressure Issue</option>
        <option>Leak Present</option>
        <option>Electrical Fault</option>
        <option>Under Investigation</option>
      </select>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Issue Summary</label>
      <input id="summary" placeholder="e.g., Bearing noise on startup"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

      <button class="w-full mt-3 bg-pindan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="submitUpdate()">Save Update</button>

      <div class="text-xs font-extrabold text-muted mt-2">Tip: tap a status button before saving.</div>
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="flex items-center justify-between gap-2.5">
        <div class="font-black text-base">Current Status (read-only)</div>
        <span class="inline-block rounded-full border border-line px-2.5 py-1 text-xs font-black tracking-wide">Auto refresh</span>
      </div>
      <div id="statusList" class="text-xs font-extrabold text-muted mt-3">Loading…</div>
    </div>
  </div>

  <!-- HANDOVER TAB -->
  <div id="tab-handover" class="px-3.5 pt-3.5 pb-5" style="display:none">
    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-[18px] mb-2">Shift Handover</div>

      <div id="handoverState"
        class="rounded-2xl border border-line bg-[#06181f] p-3 font-black leading-snug">
        Loading handover…
      </div>

      <div class="mt-3 rounded-2xl border border-line bg-[#06181f] p-3">
        <div class="font-black">Plant summary</div>
        <div class="text-xs font-extrabold text-muted mt-1">Non-operational / attention required</div>
        <div id="plantSummary" class="mt-2"></div>
      </div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Viewing notices for</label>
      <select id="audience" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base">
        <option>All</option>
        <option>Duty Manager</option>
        <option>Ops</option>
        <option>Maintenance</option>
      </select>

      <div class="mt-3 rounded-2xl border border-line bg-[#06181f] p-3">
        <div class="font-black">Relevant notices</div>
        <div id="handoverNotices" class="mt-2"></div>
      </div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">New handover message</label>
      <textarea id="handoverMsg"
        class="w-full min-h-[110px] rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400"
        placeholder="Add context or actions for the next shift (optional if the summary above is sufficient)"></textarea>

      <button class="w-full mt-3 bg-pindan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="setHandover()">Set handover</button>

      <button class="w-full mt-2 bg-plan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="ackHandover()">Acknowledge handover</button>

      <div class="text-xs font-extrabold text-muted mt-2">
        Tip: Use handover only for items that must carry into the next shift.
      </div>
    </div>
  </div>

  <!-- CHEMICAL TAB -->
  <div id="tab-chemical" class="px-3.5 pt-3.5 pb-5" style="display:none">
    <!-- (unchanged chemical UI) -->
    <!-- Keeping your chemical tab exactly as-is -->
    <!-- NOTE: This section is identical to what you pasted -->
    <!-- START chemical -->
    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-black text-[18px]">Chemical calculations</div>
          <div class="text-xs font-extrabold text-muted mt-1">Select pool volume. “Custom” unlocks manual entry.</div>
        </div>

        <!-- compact current pool readout -->
        <div class="text-xs font-extrabold text-muted text-right">
          Volume: <span id="chemVolLabel" class="text-slate-50">1,000 kL</span>
        </div>
      </div>

      <!-- Pool tabs -->
      <div class="mt-3 flex flex-wrap gap-2">
        <button type="button" class="chemPoolTab px-3 py-2 rounded-xl border border-line bg-[#06181f] font-black text-sm hover:border-pindan"
          data-pool="brac">BRAC 25m & Leisure Pool</button>

        <button type="button" class="chemPoolTab px-3 py-2 rounded-xl border border-line bg-[#06181f] font-black text-sm hover:border-pindan"
          data-pool="tbwp">Town Beach Water Park</button>

        <button type="button" class="chemPoolTab px-3 py-2 rounded-xl border border-line bg-[#06181f] font-black text-sm hover:border-pindan"
          data-pool="cbwp">Cable Beach Water Park</button>

        <button type="button" class="chemPoolTab px-3 py-2 rounded-xl border border-line bg-[#06181f] font-black text-sm hover:border-pindan"
          data-pool="custom">Custom</button>
      </div>

      <!-- Custom volume editor (hidden unless Custom selected) -->
      <div id="chemCustomWrap" class="mt-3 hidden">
        <label class="block text-sm font-extrabold text-muted mb-1">Custom pool volume</label>
        <div class="grid grid-cols-2 gap-2.5 max-[540px]:grid-cols-1">
          <input id="chemVol" inputmode="decimal" placeholder="1000" value="1000"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />
          <select id="chemVolUnit" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base">
            <option value="kL" selected>kL</option>
            <option value="L">L</option>
          </select>
        </div>
        <div class="text-xs font-extrabold text-muted mt-2" id="chemVolHint">1000 kL = 1,000,000 L</div>
      </div>
    </div>


    <div class="grid gap-3 lg:grid-cols-2">
      <!-- Current levels -->
      <div class="bg-card border border-line rounded-2xl p-3.5 mb-0">
        <div class="font-black text-base mb-1.5">Current levels</div>

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Free Chlorine (ppm)</label>
          <input id="curFC" inputmode="decimal" placeholder="e.g., 3.8"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">pH</label>
          <input id="curPH" inputmode="decimal" placeholder="e.g., 7.5"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Alkalinity (ppm)</label>
          <input id="curALK" inputmode="decimal" placeholder="e.g., 120"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Cyanuric Acid (ppm)</label>
          <input id="curCYA" inputmode="decimal" placeholder="e.g., 45"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Calcium Hardness (ppm)</label>
          <input id="curCH" inputmode="decimal" placeholder="e.g., 120"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />
      </div>
      <!-- Targets -->
      <div class="bg-card border border-line rounded-2xl p-3.5 mb-0">
        <div class="font-black text-base mb-1.5">Targets</div>

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Free Chlorine target (ppm)</label>
          <input id="tFC" inputmode="decimal" value="6"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">pH target</label>
          <input id="tPH" inputmode="decimal" value="7.5"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Alkalinity target (ppm)</label>
          <input id="tALK" inputmode="decimal" value="90"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Cyanuric Acid target (ppm)</label>
          <input id="tCYA" inputmode="decimal" value="45"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

          <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Calcium Hardness target (ppm)</label>
          <input id="tCH" inputmode="decimal" value="120"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

          <button class="w-full mt-3 bg-pindan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
            type="button" onclick="runChem()">Calculate</button>

          <button class="w-full mt-2 bg-plan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
            type="button" onclick="copyChemNotes(false)">Copy to notes</button>

          <button class="w-full mt-2 bg-teal rounded-2xl px-3 py-3 text-[17px] font-black text-white"
            type="button" onclick="copyChemNotes(true)">Copy + add to handover</button>

          <div class="text-xs font-extrabold text-muted mt-2">Tip: “Copy + add to handover” appends the dosing block into the Handover message box.</div>
      </div>
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base mb-1.5">Dose results</div>
      <div id="chemResults" class="text-xs font-extrabold text-muted">Enter values and press Calculate.</div>
    </div>

    <!-- Results Modal -->
    <div id="chemModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/60" onclick="closeChemModal()"></div>

      <div class="absolute left-1/2 top-1/2 w-[92vw] max-w-2xl -translate-x-1/2 -translate-y-1/2">
        <div class="bg-card border border-line rounded-2xl p-4 shadow-xl">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-black text-lg">Dose results</div>
              <div class="text-xs font-extrabold text-muted mt-1" id="chemModalSub">
                Review dosing before adding chemicals.
              </div>
            </div>

            <button type="button"
              class="rounded-xl px-3 py-2 font-black bg-[#06181f] border border-line hover:border-pindan"
              onclick="closeChemModal()">
              Close
            </button>
          </div>

          <div class="mt-3 text-sm font-semibold text-slate-100/90 whitespace-pre-wrap" id="chemResultsModal">
            —
          </div>

          <div class="mt-4 flex flex-col sm:flex-row gap-2">
            <button class="w-full bg-plan rounded-2xl px-3 py-3 text-[15px] font-black text-white"
              type="button" onclick="copyChemNotes(false)">Copy to notes</button>

            <button class="w-full bg-teal rounded-2xl px-3 py-3 text-[15px] font-black text-white"
              type="button" onclick="copyChemNotes(true)">Copy + add to handover</button>
          </div>
        </div>
      </div>
    </div>


    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base mb-1.5">Safety reminders</div>
      <div class="text-xs font-extrabold text-muted leading-relaxed">
        • Follow facility SOP + SDS for handling/dosing.<br>
        • Add chemical to water where applicable (never water to chemical).<br>
        • Don’t exceed max dosing limits if your SOP has them.<br>
        • Record dosing where required.
      </div>
    </div>
    <!-- END chemical -->
  </div>

  <!-- NOTICES TAB -->
  <div id="tab-notices" class="px-3.5 pt-3.5 pb-5" style="display:none">
    <!-- (unchanged notices UI) -->
    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-black text-[18px]">Noticeboard Manager</div>
          <div class="text-xs font-extrabold text-muted mt-1">
            Create, edit, and remove notices shown on Wall + Handover.
          </div>
        </div>

        <div class="flex gap-2">
          <button class="rounded-2xl px-3 py-2 font-black text-white bg-plan"
            type="button" onclick="loadNoticesManager(true)">Refresh</button>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap gap-2 items-center">
        <label class="text-xs font-extrabold text-muted">View</label>
        <select id="noticeFilter" class="rounded-xl border border-line bg-[#06181f] px-3 py-2 text-sm font-extrabold"
          onchange="renderNoticesManager()">
          <option value="active" selected>Active only</option>
          <option value="all">All (incl. expired/future)</option>
        </select>

        <div class="ml-auto text-xs font-extrabold text-muted" id="noticeCount">—</div>
      </div>
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base">Existing notices</div>
      <div class="text-xs font-extrabold text-muted mt-1">Tap Edit to load into the form below.</div>

      <div id="noticeList" class="mt-3 space-y-2">
        <div class="text-xs font-extrabold text-muted">Loading…</div>
      </div>
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="flex items-center justify-between gap-3">
        <div class="font-black text-base" id="noticeFormTitle">Create new notice</div>

        <button class="rounded-2xl px-3 py-2 font-black text-white bg-[#0f766e]"
          type="button" onclick="resetNoticeForm()">New</button>
      </div>

      <input type="hidden" id="noticeRow" value="" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Title</label>
      <input id="nTitle" placeholder="e.g., Lane 3 closed"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Message</label>
      <textarea id="nMsg" placeholder="Short operational notice..."
        class="w-full min-h-[110px] rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400"></textarea>

      <div class="grid grid-cols-2 gap-2.5 max-[540px]:grid-cols-1 mt-3">
        <div>
          <label class="block text-sm font-extrabold text-muted mb-1">Category</label>
          <select id="nCat" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base">
            <option>Notice</option>
            <option>Safety</option>
            <option>Ops</option>
            <option>Info</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-extrabold text-muted mb-1">Audience</label>
          <select id="nAud" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base">
            <option>All</option>
            <option>Duty Manager</option>
            <option>Ops</option>
            <option>Maintenance</option>
            <option value="custom">Custom… (comma separated)</option>
          </select>
        </div>
      </div>

      <div id="audCustomWrap" class="mt-3" style="display:none">
        <label class="block text-sm font-extrabold text-muted mb-1">Custom audience (comma separated)</label>
        <input id="nAudCustom" placeholder="e.g., Duty Manager, Ops"
          class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />
        <div class="text-xs font-extrabold text-muted mt-1">Leave blank for All.</div>
      </div>

      <div class="grid grid-cols-2 gap-2.5 max-[540px]:grid-cols-1 mt-3">
        <div>
          <label class="block text-sm font-extrabold text-muted mb-1">Start (optional)</label>
          <input id="nStart" type="datetime-local" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />
        </div>
        <div>
          <label class="block text-sm font-extrabold text-muted mb-1">End (optional)</label>
          <input id="nEnd" type="datetime-local" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />
        </div>
      </div>

      <button class="w-full mt-3 bg-pindan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="saveNotice()">Save notice</button>

      <button class="w-full mt-2 bg-bad rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="deleteNoticeFromForm()">Delete this notice</button>

      <div class="text-xs font-extrabold text-muted mt-2">
        Tip: Leave Start/End blank for “always active”. Use End to auto-expire.
      </div>
    </div>
  </div>

  <!-- REQUIRED: toast container (your JS uses this) -->
  <div id="toast"
       class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden max-w-[92vw]
              rounded-2xl border border-line bg-card px-4 py-3 text-sm font-black shadow-lg">
    Toast
  </div>

  <!-- REQUIRED: hidden iframe for POST writes -->
  <iframe name="writeSink" style="display:none"></iframe>

<script>
/***********************
 * WRITE HELPER (NEW)
 ***********************/
const API_BASE = "/api";

// Boot
wireStatusButtons();
wireAudienceCustom();



async function loginWithValue(val){
  val = (val || "").trim();
  const errEl = document.getElementById('loginErr');

  // treat 4–8 digits as PIN, otherwise RFID UID
  const isPin = /^\d{4,8}$/.test(val);
  const payload = isPin ? { pin: val } : { rfid: val };

  const r = await fetch('/api/auth_login.php', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload),
    credentials: 'same-origin'
  });

  const ct = (r.headers.get('content-type') || '').toLowerCase();
  const j = ct.includes('application/json') ? await r.json().catch(()=>null) : null;

  if (!r.ok || !j || !j.ok){
    const msg = (j && j.error) ? j.error : `Login failed (HTTP ${r.status})`;
    if (errEl){ errEl.textContent = msg; errEl.classList.remove('hidden'); }
    throw new Error(msg);
  }

  sessionStorage.setItem('staff', JSON.stringify(j.user));
  const gate = document.getElementById('loginGate');
  if (gate) gate.style.display = 'none';

  // welcome badge if present
  const badge = document.getElementById('welcomeBadge');
  if (badge && j.user && j.user.name){
    badge.textContent = `Welcome ${j.user.name}!`;
    badge.classList.remove('hidden');
  }

  return j.user;
}

// Unlock button -> attempt login
document.getElementById('loginBtn').onclick = async () => {
  const v = document.getElementById('loginPin').value.trim();
  const errEl = document.getElementById('loginErr');
  if (errEl){ errEl.textContent = ''; errEl.classList.add('hidden'); }
  try { await loginWithValue(v); } catch(e) { /* error shown */ }
};

// RFID readers usually type UID + Enter
document.getElementById('loginPin').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('loginBtn').click();
});

// Auto-check session on load (tolerate 401/HTML so we don't crash)
fetch('/api/auth_check.php', { cache:'no-store', credentials:'same-origin' })
  .then(async (r) => {
    const ct = (r.headers.get('content-type') || '').toLowerCase();
    if (!r.ok || !ct.includes('application/json')) return null;
    return r.json().catch(()=>null);
  })
  .then((j) => {
    if (j && j.ok){
      sessionStorage.setItem('staff', JSON.stringify(j.user));
      const gate = document.getElementById('loginGate');
      if (gate) gate.style.display = 'none';
      const badge = document.getElementById('welcomeBadge');
      if (badge && j.user && j.user.name){
        badge.textContent = `Welcome ${j.user.name}!`;
        badge.classList.remove('hidden');
      }
    }
  })
  .catch(()=>{});
async function apiGet(path){
  const res = await fetch(API_BASE + path, { cache:"no-store" });
  if (!res.ok) throw new Error("GET " + path + " failed: " + res.status);
  const j = await res.json();
  if (!j || !j.ok) throw new Error((j && j.error) ? j.error : ("API not-ok: " + path));
  return j;
}

async function apiPost(path, payload){
  const res = await fetch(API_BASE + path, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload || {})
  });
  const j = await res.json().catch(()=>null);
  if (!res.ok || !j || !j.ok){
    const err = (j && j.error) ? j.error : ("POST " + path + " failed: " + res.status);
    throw new Error(err);
  }
  return j;
}

window.addEventListener("error", (ev) => {
  const msg = ev && ev.message ? ev.message : "Unknown script error";
  toast("JS ERROR: " + msg, 6000);
});

// === DB API URLS (preferred) ===
const PLANT_API_URL = API_BASE + "/plant_status_list.php";
const NOTICE_API_URL = API_BASE + "/noticeboard_list.php";        // active notices (optionally filtered)
const NOTICE_ADMIN_API_URL = API_BASE + "/noticeboard_admin_list.php"; // active/all for manager
const NOTICE_SAVE_API_URL = API_BASE + "/noticeboard_save.php";
const NOTICE_DELETE_API_URL = API_BASE + "/noticeboard_delete.php";

const HANDOVER_API_URL = API_BASE + "/handover_active.php";
const HANDOVER_SET_API_URL = API_BASE + "/handover_set.php";
const HANDOVER_ACK_API_URL = API_BASE + "/handover_ack.php";

// === Legacy CSV fallbacks (kept for safety) ===
const PLANT_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=0&single=true&output=csv";

const NOTICE_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=684780974&single=true&output=csv";

const HANDOVER_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=871823190&single=true&output=csv";
let cached = [];
let selectedStatus = "";
let chemLast = null;

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

function toMysqlDatetime(inputVal){
  // Accepts datetime-local like "2026-02-18T06:54" and returns MySQL DATETIME "2026-02-18 06:54:00"
  const v = String(inputVal || "").trim();
  if (!v) return null;
  // already mysql-ish
  if (v.includes(" ") && v.match(/^\d{4}-\d{2}-\d{2} /)) return v.length === 16 ? (v + ":00") : v;
  const s = v.replace("T", " ");
  if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(s)) return s + ":00";
  return s; // best effort
}

function setDefaultNoticeStartNow(){
  const startEl = document.getElementById("nStart");
  if (!startEl) return;

  const d = new Date();
  const pad = n => String(n).padStart(2, "0");
  const local =
    d.getFullYear() + "-" +
    pad(d.getMonth() + 1) + "-" +
    pad(d.getDate()) + "T" +
    pad(d.getHours()) + ":" +
    pad(d.getMinutes());

  startEl.value = local; // default Start = now
}


function fromMysqlDatetime(mysqlVal){
  // Converts "2026-02-18 06:54:07" -> "2026-02-18T06:54" for datetime-local inputs
  const v = String(mysqlVal || "").trim();
  if (!v) return "";
  const m = v.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})/);
  return m ? `${m[1]}T${m[2]}` : "";
}

function toast(msg, ms=1800){
  const t = document.getElementById("toast");
  if (!t) { alert(msg); return; }
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", ms);
}

function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQuotes = false;

  for (let i=0; i<text.length; i++){
    const c = text[i];
    const next = text[i+1];

    if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
    if (c === '"') { inQuotes = !inQuotes; continue; }

    if (!inQuotes && c === ',') { row.push(cur); cur=""; continue; }
    if (!inQuotes && (c === '\n' || c === '\r')) {
      if (c === '\r' && next === '\n') i++;
      row.push(cur); cur="";
      if (row.some(v => v !== "")) rows.push(row);
      row = [];
      continue;
    }
    cur += c;
  }
  row.push(cur);
  if (row.some(v => v !== "")) rows.push(row);
  return rows;
}

function rankStatus(s){
  s = (s || "").trim().toLowerCase();
  if (s === "offline") return 1;
  if (s === "degraded") return 2;
  if (s === "planned maintenance") return 3;
  return 4;
}

function isActiveNotice(startStr, endStr){
  const now = new Date();
  const start = startStr ? new Date(startStr) : null;
  const end = endStr ? new Date(endStr) : null;
  const okStart = !startStr || (!isNaN(start) && start <= now);
  const okEnd = !endStr || (!isNaN(end) && end >= now);
  return okStart && okEnd;
}

function audienceMatches(audienceCell, selected){
  const raw = (audienceCell || "").trim();
  if (!raw || raw.toLowerCase() === "all") return true;
  const parts = raw.split(",").map(x => x.trim().toLowerCase()).filter(Boolean);
  return parts.includes(String(selected).trim().toLowerCase()) || parts.includes("all");
}

async function loadPlant(){
  // Prefer DB API; fall back to legacy CSV if needed.
  let items = [];
  try{
    const j = await apiGet("/plant_status_list.php");
    const rows = Array.isArray(j.rows) ? j.rows : [];
    items = rows.map(r => ({
      id: String(r.component_id || "").trim(),
      name: String(r.component_name || "").trim(),
      status: String(r.status || "").trim(),
      issue: String(r.issue_summary || "").trim()
    })).filter(x => x.id && x.name);
  } catch(e){
    // Legacy CSV fallback
    const res = await fetch(PLANT_CSV_URL, { cache:"no-store" });
    const csv = await res.text();
    const data = parseCSV(csv);
    const headers = data[0];
    const idx = (n) => headers.indexOf(n);

    const iId = idx("Component ID");
    const iName = idx("Component Name");
    const iStatus = idx("Status");
    const iIssue = idx("Issue Summary");

    items = data.slice(1).map(r => ({
      id: (r[iId] || "").trim(),
      name: (r[iName] || "").trim(),
      status: (r[iStatus] || "").trim(),
      issue: (r[iIssue] || "").trim()
    })).filter(x => x.id && x.name);
  }

  cached = items;

  const sel = document.getElementById("component");
  sel.innerHTML = items.map(x =>
    `<option value="${escapeHtml(x.id)}">${escapeHtml(x.name)} (${escapeHtml(x.id)})</option>`
  ).join("");

  const list = items
    .slice()
    .sort((a,b) => rankStatus(a.status) - rankStatus(b.status) || a.name.localeCompare(b.name))
    .map(it => `• ${it.name}: ${it.status || "Operational"}`)
    .join("<br>");

  document.getElementById("statusList").innerHTML = list || "No data";
}

function wireStatusButtons(){
  document.querySelectorAll("#statusButtons .btn").forEach(btn => {
    btn.addEventListener("click", () => {
      selectedStatus = btn.dataset.status || "";
      document.getElementById("chosenStatus").textContent = "Selected status: " + selectedStatus;
      document.querySelectorAll("#statusButtons .btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
    });
  });
}

/***********************
 * UPDATE (WRITE) - CHANGED
 ***********************/
async function submitUpdate(){
  try{
    const componentId = document.getElementById("component").value;
    const condition = document.getElementById("condition").value;
    const summary = document.getElementById("summary").value;

    if (!componentId) return toast("Pick a component first.");
    if (!selectedStatus) return toast("Tap a Status button first.");

    toast("Saving…", 1500);

    await apiPost("/plant_status_update.php", {
      component_id: componentId,
      status: selectedStatus,
      condition_name: condition,
      issue_summary: summary
    });

    toast("Saved ✅", 1600);
    document.getElementById("summary").value = "";
    await loadPlant();
  } catch(e){
    console.error(e);
    toast("Save failed (network/browser error)", 3200);
  }
}

function buildPlantSummary(){
  const nonOp = cached
    .filter(it => rankStatus(it.status) <= 3 && (it.status || "").trim().toLowerCase() !== "operational")
    .sort((a,b) => rankStatus(a.status) - rankStatus(b.status));

  if (!nonOp.length){
    return `<ul class="text-xs font-extrabold text-muted" style="margin:8px 0 0 18px"><li>No non-operational items</li></ul>`;
  }

  return `<ul class="text-xs font-extrabold text-muted" style="margin:8px 0 0 18px">` + nonOp.map(it =>
    `<li><strong>${escapeHtml(it.name)}</strong> — ${escapeHtml(it.status)}${it.issue ? " • " + escapeHtml(it.issue) : ""}</li>`
  ).join("") + `</ul>`;
}

async function loadNoticesForHandover(){
  const selected = document.getElementById("audience").value;

  // Prefer DB API; fall back to legacy CSV if needed.
  let items = [];
  try{
    const j = await apiGet("/noticeboard_admin_list.php?scope=active");
    const rows = Array.isArray(j.rows) ? j.rows : [];
    items = rows.map(r => ({
      title: String(r.title || "").trim(),
      msg: String(r.message || "").trim(),
      start: r.start_at ? String(r.start_at).trim() : "",
      end: r.end_at ? String(r.end_at).trim() : "",
      aud: String(r.audience || "All").trim()
    })).filter(x => x.title || x.msg);
  } catch(e){
    const res = await fetch(NOTICE_CSV_URL, { cache:"no-store" });
    const csv = await res.text();
    const rows = parseCSV(csv);
    const headers = rows[0];
    const idx = (n) => headers.indexOf(n);

    const iTitle = idx("Title");
    const iMsg = idx("Message");
    const iStart = idx("Start");
    const iEnd = idx("End");
    const iAud = idx("Audience");

    items = rows.slice(1).map(r => ({
      title: (r[iTitle] || "").trim(),
      msg: (r[iMsg] || "").trim(),
      start: (r[iStart] || "").trim(),
      end: (r[iEnd] || "").trim(),
      aud: (r[iAud] || "").trim()
    })).filter(x => x.title || x.msg);
  }

  const active = items
    .filter(n => isActiveNotice(n.start, n.end))
    .filter(n => audienceMatches(n.aud, selected))
    .slice(0, 6);

  if (!active.length){
    return `<ul class="text-xs font-extrabold text-muted" style="margin:8px 0 0 18px"><li>No active notices for ${escapeHtml(selected)}</li></ul>`;
  }

  return `<ul class="text-xs font-extrabold text-muted" style="margin:8px 0 0 18px">` + active.map(n =>
    `<li><strong>${escapeHtml(n.title || "Notice")}</strong>${n.msg ? " — " + escapeHtml(n.msg) : ""}</li>`
  ).join("") + `</ul>`;
}

async function refreshHandover(){
  const state = document.getElementById("handoverState");

  try{
    // Prefer DB API
    const j = await apiGet("/handover_active.php");

    if (j.active && j.message){
      state.classList.add("active");
      const created = j.created_at ? String(j.created_at).trim() : "";
      state.innerHTML = `Active handover<div class="text-xs font-extrabold text-muted" style="margin-top:6px">${escapeHtml(j.message)}${created ? `<br><span style="opacity:.85">Created: ${escapeHtml(created)}</span>` : ""}</div>`;
    } else {
      state.classList.remove("active");
      state.innerHTML = `No active handover<div class="text-xs font-extrabold text-muted" style="margin-top:6px;opacity:.9">Nothing pending for the next shift.</div>`;
    }

    document.getElementById("plantSummary").innerHTML = buildPlantSummary();
    document.getElementById("handoverNotices").innerHTML = await loadNoticesForHandover();
    return;
  } catch(e){
    // Fallback to legacy CSV
    try{
      const res = await fetch(HANDOVER_CSV_URL, { cache:"no-store" });
      const csv = await res.text();
      const data = parseCSV(csv);
      const headers = data[0];
      const row = data[1] || [];
      const idx = (n) => headers.indexOf(n);

      const active = (row[idx("Active")] || "").trim().toLowerCase();
      const msg = (row[idx("Message")] || "").trim();
      const created = (row[idx("Created")] || "").trim();
      const ack = (row[idx("Acknowledged")] || "").trim().toLowerCase();

      if (active === "yes" && ack !== "yes" && msg){
        state.classList.add("active");
        state.innerHTML = `Active handover<div class="text-xs font-extrabold text-muted" style="margin-top:6px">${escapeHtml(msg)}<br><span style="opacity:.85">Created: ${escapeHtml(created)}</span></div>`;
      } else {
        state.classList.remove("active");
        state.innerHTML = `No active handover<div class="text-xs font-extrabold text-muted" style="margin-top:6px;opacity:.9">Nothing pending for the next shift.</div>`;
      }

      document.getElementById("plantSummary").innerHTML = buildPlantSummary();
      document.getElementById("handoverNotices").innerHTML = await loadNoticesForHandover();
    } catch(err){
      console.error(err);
      state.textContent = "Could not load handover.";
      document.getElementById("plantSummary").innerHTML = "";
      document.getElementById("handoverNotices").innerHTML = "";
    }
  }
}

/************************
 * HANDOVER (WRITE) - CHANGED
 ***********************/
async function setHandover(){
  const message = document.getElementById("handoverMsg").value.trim();
  if (!message) return toast("Enter a short handover message first.");

  toast("Setting handover…", 1500);

  await apiPost("/handover_set.php", { message });

  toast("Handover set ✅", 2000);
  document.getElementById("handoverMsg").value = "";
  await refreshHandover();
}

async function ackHandover(){
  toast("Acknowledging…", 1500);

  await apiPost("/handover_ack.php", { });

  toast("Acknowledged ✅", 2000);
  await refreshHandover();
}

function switchTab(which){
  const panels = {
    update: document.getElementById("tab-update"),
    handover: document.getElementById("tab-handover"),
    chemical: document.getElementById("tab-chemical"),
    notices: document.getElementById("tab-notices"),
  };

  const buttons = {
    update: document.getElementById("btnUpdate"),
    handover: document.getElementById("btnHandover"),
    chemical: document.getElementById("btnChemical"),
    notices: document.getElementById("btnNotices"),
  };

  if (!panels[which]) {
    toast(`ERROR: Tab "${which}" not found in HTML`, 4500);
    return;
  }

  Object.keys(panels).forEach(k => {
    if (panels[k]) panels[k].style.display = (k === which) ? "block" : "none";
    if (buttons[k]) buttons[k].classList.toggle("active", k === which);
  });

  if (which === "handover") refreshHandover();
  if (which === "notices") loadNoticesManager(false);
}

/***********************
 * CHEM (unchanged)
 ***********************/
// (Your full chem JS remains unchanged below)

function num(id){
  const v = document.getElementById(id)?.value;
  const n = parseFloat(String(v ?? "").replace(/,/g,"").trim());
  return Number.isFinite(n) ? n : NaN;
}

function roundup(x, decimals){
  if (!Number.isFinite(x)) return NaN;
  const m = Math.pow(10, decimals);
  return Math.ceil(x * m) / m;
}

function poolLitres(){
  const v = num("chemVol");
  const unit = document.getElementById("chemVolUnit").value;
  if (!Number.isFinite(v) || v <= 0) return NaN;
  return unit === "kL" ? v * 1000 : v;
}

function pureKg(deltaPpm, volL){
  return (deltaPpm * volL) / 1000000;
}

function fmt(x, suffix){
  if (!Number.isFinite(x)) return "—";
  return `${x.toLocaleString(undefined,{maximumFractionDigits:2})}${suffix||""}`;
}

function line(title, value){
  return `<div style="margin:6px 0"><strong>${escapeHtml(title)}:</strong> ${escapeHtml(value)}</div>`;
}

function nowStamp(){
  const d = new Date();
  return d.toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  } catch {
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    return ok;
  }
}

function buildChemNotes(){
  if (!chemLast) return "";

  const lines = [];
  lines.push(`CHEM CALC (${chemLast.volumeKL} kL)`);
  if (chemLast.fc){
    lines.push(`FC: ${chemLast.fc.cur} → ${chemLast.fc.tgt} | Dose: ${chemLast.fc.hypoL} L sodium hypo (10.42%) | ${fmt(chemLast.fc.calHypoKg," kg")} cal hypo (62.5%)`);
  }
  if (chemLast.ph){
    lines.push(`pH: ${chemLast.ph.cur} → ${chemLast.ph.tgt} | Dose: ${chemLast.ph.acidL} L sulphuric acid`);
  }
  if (chemLast.alk){
    lines.push(`ALK: ${chemLast.alk.cur} → ${chemLast.alk.tgt} | Dose: ${fmt(chemLast.alk.bicarbKg," kg")} sodium bicarb`);
  }
  if (chemLast.cya){
    lines.push(`CYA: ${chemLast.cya.cur} → ${chemLast.cya.tgt} | Dose: ${chemLast.cya.cyaKg} kg cyanuric acid`);
  }
  if (chemLast.ch){
    lines.push(`CH: ${chemLast.ch.cur} → ${chemLast.ch.tgt} | Dose: ${chemLast.ch.caCl2Kg} kg calcium chloride (91%)`);
  }
  if (chemLast.thioKg !== null){
    lines.push(`If reducing Cl: Thiosulphate: ${fmt(chemLast.thioKg," kg")}`);
  }
  lines.push(`Timestamp: ${nowStamp()}`);
  return lines.join("\n");
}

async function copyChemNotes(addToHandover=false){
  if (!chemLast) return toast("Run Calculate first.", 2000);

  const text = buildChemNotes();
  const ok = await copyText(text);

  if (addToHandover){
    switchTab("handover");
    const box = document.getElementById("handoverMsg");
    if (box){
      box.value = (box.value.trim() ? box.value.trim() + "\n\n" : "") + text;
    }
    await refreshHandover();
  }

  toast(ok ? "Copied ✅" : "Copy failed (browser)", 2200);
}

function runChem(){
  const V = poolLitres();
  if (!Number.isFinite(V)) return toast("Enter a valid pool volume.", 2200);

  const volumeKL = Math.round(V / 1000);

  const curFC = num("curFC");
  const curPH = num("curPH");
  const curALK = num("curALK");
  const curCYA = num("curCYA");
  const curCH = num("curCH");

  const tFC = num("tFC");
  const tPH = num("tPH");
  const tALK = num("tALK");
  const tCYA = num("tCYA");
  const tCH = num("tCH");

  let out = "";
  const snap = { volumeKL, fc:null, ph:null, alk:null, cya:null, ch:null, thioKg:null };

  if (Number.isFinite(curFC) && Number.isFinite(tFC)) {
    const d = tFC - curFC;
    const Fkg = pureKg(d, V);

    const strengthHypo = 10.42 / 100;
    const densityHypo = 1.2;
    const Lhypo = (Fkg / strengthHypo) / densityHypo;
    const LhypoOut = roundup(Math.max(Lhypo, 0), 0);

    const strengthCal = 62.5 / 100;
    const kgCal = Math.max(Fkg / strengthCal, 0);

    out += `<div style="margin-top:10px;font-weight:900">Chlorine</div>`;
    out += line("Sodium Hypochlorite (10.42%)", fmt(LhypoOut, " L"));
    out += line("Calcium Hypochlorite (62.5%)", fmt(kgCal, " kg"));

    const thioKg = Math.max((curFC - tFC) / 1, 0);
    snap.thioKg = thioKg;

    snap.fc = { cur: curFC, tgt: tFC, hypoL: LhypoOut, calHypoKg: kgCal };
  } else {
    out += `<div style="margin-top:10px;font-weight:900">Chlorine</div>`;
    out += `<div class="text-xs font-extrabold text-muted">Enter current + target Free Chlorine to calculate.</div>`;
    snap.thioKg = null;
  }

  if (Number.isFinite(curPH) && Number.isFinite(tPH)) {
    const steps = Math.max((curPH - tPH) / 0.1, 0);
    const acidL = roundup(steps * 10 * V / 1000000, 1);

    out += `<div style="margin-top:14px;font-weight:900">pH</div>`;
    out += line("Sulphuric Acid", fmt(acidL, " L"));

    snap.ph = { cur: curPH, tgt: tPH, acidL };
  } else {
    out += `<div style="margin-top:14px;font-weight:900">pH</div>`;
    out += `<div class="text-xs font-extrabold text-muted">Enter current + target pH to calculate.</div>`;
  }

  if (Number.isFinite(curALK) && Number.isFinite(tALK)) {
    const d = tALK - curALK;
    const kg = Math.max(pureKg(d, V), 0);

    out += `<div style="margin-top:14px;font-weight:900">Alkalinity</div>`;
    out += line("Sodium Bicarbonate", fmt(kg, " kg"));

    snap.alk = { cur: curALK, tgt: tALK, bicarbKg: kg };
  } else {
    out += `<div style="margin-top:14px;font-weight:900">Alkalinity</div>`;
    out += `<div class="text-xs font-extrabold text-muted">Enter current + target alkalinity to calculate.</div>`;
  }

  if (Number.isFinite(curCYA) && Number.isFinite(tCYA)) {
    const d = tCYA - curCYA;
    const kg = roundup(Math.max(pureKg(d, V), 0), 0);

    out += `<div style="margin-top:14px;font-weight:900">Cyanuric Acid</div>`;
    out += line("Cyanuric Acid", fmt(kg, " kg"));

    snap.cya = { cur: curCYA, tgt: tCYA, cyaKg: kg };
  } else {
    out += `<div style="margin-top:14px;font-weight:900">Cyanuric Acid</div>`;
    out += `<div class="text-xs font-extrabold text-muted">Enter current + target CYA to calculate.</div>`;
  }

  if (Number.isFinite(curCH) && Number.isFinite(tCH)) {
    const d = tCH - curCH;
    const Fkg = pureKg(d, V);
    const strength = 0.91;
    const kg = roundup(Math.max(Fkg / strength, 0), 1);

    out += `<div style="margin-top:14px;font-weight:900">Calcium Hardness</div>`;
    out += line("Calcium Chloride (91%)", fmt(kg, " kg"));

    snap.ch = { cur: curCH, tgt: tCH, caCl2Kg: kg };
  } else {
    out += `<div style="margin-top:14px;font-weight:900">Calcium Hardness</div>`;
    out += `<div class="text-xs font-extrabold text-muted">Enter current + target calcium hardness to calculate.</div>`;
  }

  // ✅ NEW: show in modal (and optionally keep bottom div updated if it exists)
  const inline = document.getElementById("chemResults");
  if (inline) inline.innerHTML = out; // safe if you keep/remove the old results card

  openChemModalHtml(out);

  chemLast = snap;
  toast("Calculated ✅", 1200);
}

function openChemModalHtml(html){
  const box = document.getElementById("chemResultsModal");
  const modal = document.getElementById("chemModal");
  if (!box || !modal) return; // fail safe if modal not on page
  box.innerHTML = html || "—";
  modal.classList.remove("hidden");
}

function closeChemModal(){
  const modal = document.getElementById("chemModal");
  if (!modal) return;
  modal.classList.add("hidden");
}

// --- POOL PRESETS (edit these volumes to your real pools) ---
const CHEM_POOLS = {
  brac:   { label: "BRAC 25m & Leisure Pool", vol: 1000, unit: "kL" },
  tbwp:  { label: "Town Beach Water Park", vol: 0, unit: "kL" },
  cbwp: { label: "Cable Beach Water Park", vol: 0, unit: "kL" },
  custom: { label: "Custom", vol: null, unit: null }
};

let selectedChemPool = "brac";

function fmtVol(vol, unit){
  if (vol == null) return "Custom";
  const n = Number(vol);
  if (!isFinite(n)) return `${vol} ${unit}`;
  return `${n.toLocaleString()} ${unit}`;
}

function setChemPool(poolKey){
  selectedChemPool = poolKey;

  // tab styling
  document.querySelectorAll(".chemPoolTab").forEach(btn => {
    const active = btn.dataset.pool === poolKey;
    btn.classList.toggle("border-pindan", active);
    btn.classList.toggle("bg-[#06181f]", !active);
  });

  const preset = CHEM_POOLS[poolKey];
  const customWrap = document.getElementById("chemCustomWrap");
  const label = document.getElementById("chemVolLabel");

  if (poolKey === "custom") {
    customWrap.classList.remove("hidden");
    // keep whatever user typed
    label.textContent = fmtVol(document.getElementById("chemVol").value, document.getElementById("chemVolUnit").value);
  } else {
    customWrap.classList.add("hidden");

    // push preset into your existing inputs so runChem() stays unchanged
    document.getElementById("chemVol").value = preset.vol;
    document.getElementById("chemVolUnit").value = preset.unit;

    label.textContent = fmtVol(preset.vol, preset.unit);
  }
}

// keep label updated when user edits custom volume
function wireChemVolumeLabel(){
  const vol = document.getElementById("chemVol");
  const unit = document.getElementById("chemVolUnit");
  const label = document.getElementById("chemVolLabel");
  function update(){ label.textContent = fmtVol(vol.value, unit.value); }
  vol.addEventListener("input", update);
  unit.addEventListener("change", update);
}

function openChemModal(text){
  document.getElementById("chemResultsModal").textContent = text || "—";
  document.getElementById("chemModal").classList.remove("hidden");
}

function closeChemModal(){
  document.getElementById("chemModal").classList.add("hidden");
}

// call this once when the chemical tab exists in DOM
function initChemUI(){
  document.querySelectorAll(".chemPoolTab").forEach(btn => {
    btn.addEventListener("click", () => setChemPool(btn.dataset.pool));
  });
  wireChemVolumeLabel();
  setChemPool("brac"); // default
}


/***********************
 * NOTICES MANAGER (WRITE) - CHANGED
 ***********************/
let noticesCache = [];

function parseMaybeDate(s){
  const t = String(s || "").trim();
  if (!t) return null;
  const d = new Date(t);
  return isNaN(d) ? null : d;
}

function noticeStatus(n){
  const now = new Date();
  const start = parseMaybeDate(n.start);
  const end = parseMaybeDate(n.end);

  const okStart = !n.start || (start && start <= now);
  const okEnd = !n.end || (end && end >= now);

  if (okStart && okEnd) return "active";
  if (start && start > now) return "future";
  if (end && end < now) return "expired";
  return "other";
}

function pillClassForStatus(st){
  if (st === "active") return "bg-good text-white";
  if (st === "future") return "bg-plan text-white";
  if (st === "expired") return "bg-[#374151] text-slate-200";
  return "bg-[#374151] text-slate-200";
}

function getAudienceValue(){
  const audSel = document.getElementById("nAud").value;
  if (audSel === "custom") {
    const raw = document.getElementById("nAudCustom").value.trim();
    return raw || "All";
  }
  return audSel || "All";
}

function wireAudienceCustom(){
  const sel = document.getElementById("nAud");
  if (!sel) return;
  sel.addEventListener("change", () => {
    const wrap = document.getElementById("audCustomWrap");
    if (!wrap) return;
    wrap.style.display = (sel.value === "custom") ? "block" : "none";
  });
}

async function loadNoticesManager(showToast=true){
  try{
    const scope = (document.getElementById("noticeFilter")?.value || "active") === "all" ? "all" : "active";
    const res = await fetch(NOTICE_ADMIN_API_URL + `?scope=${encodeURIComponent(scope)}`, { cache:"no-store" });
    if (!res.ok) throw new Error("Notice admin API fetch failed: " + res.status);
    const j = await res.json();
    if (!j.ok) throw new Error(j.error || "Notice admin API returned not-ok");
    const rows = Array.isArray(j.rows) ? j.rows : [];

    noticesCache = rows.map(r => ({
      id: r.id,
      title: String(r.title || "").trim(),
      msg: String(r.message || "").trim(),
      cat: String(r.category || "").trim(),
      start: r.start_at ? String(r.start_at).trim() : "",
      end: r.end_at ? String(r.end_at).trim() : "",
      aud: String(r.audience || "All").trim(),
    })).filter(x => x.title || x.msg);

    renderNoticesManager();
    if (showToast) toast("Notices loaded ✅", 1400);
    return;
  } catch(e){
    // Legacy CSV fallback
    try{
      const res = await fetch(NOTICE_CSV_URL, { cache:"no-store" });
      const csv = await res.text();
      const rows = parseCSV(csv);
      const headers = rows[0] || [];
      const idx = (n) => headers.indexOf(n);

      const iTitle = idx("Title");
      const iMsg = idx("Message");
      const iCat = idx("Category");
      const iStart = idx("Start");
      const iEnd = idx("End");
      const iAud = idx("Audience");

      noticesCache = rows.slice(1).map((r, i) => ({
        id: i + 2,
        title: (r[iTitle] || "").trim(),
        msg: (r[iMsg] || "").trim(),
        cat: (r[iCat] || "").trim(),
        start: (r[iStart] || "").trim(),
        end: (r[iEnd] || "").trim(),
        aud: (r[iAud] || "").trim(),
      })).filter(x => x.title || x.msg);

      renderNoticesManager();
      if (showToast) toast("Notices loaded ✅", 1400);
    } catch(err){
      console.error(err);
      document.getElementById("noticeList").innerHTML =
        `<div class="text-xs font-extrabold text-muted">Could not load notices.</div>`;
      if (showToast) toast("Could not load notices", 2400);
    }
  }
}

function renderNoticesManager(){
  const filter = document.getElementById("noticeFilter")?.value || "active";
  const listEl = document.getElementById("noticeList");
  if (!listEl) return;

  const filtered = noticesCache
    .slice()
    .sort((a,b) => (parseMaybeDate(b.start)?.getTime()||0) - (parseMaybeDate(a.start)?.getTime()||0));

  const shown = (filter === "all") ? filtered : filtered.filter(n => noticeStatus(n) === "active");

  document.getElementById("noticeCount").textContent =
    `${shown.length} shown • ${noticesCache.length} total`;

  if (!shown.length){
    listEl.innerHTML = `<div class="text-xs font-extrabold text-muted">No notices in this view.</div>`;
    return;
  }

  listEl.innerHTML = shown.map(n => {
    const st = noticeStatus(n);
    const pill = st.toUpperCase();
    const aud = (n.aud || "All").trim();

    return `
      <div class="border border-line rounded-2xl bg-[#06181f] p-3">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-black text-sm truncate">${escapeHtml(n.title || "Notice")}</div>
            <div class="text-xs font-extrabold text-muted mt-1 leading-snug">
              ${escapeHtml(n.msg || "")}
            </div>
            <div class="text-[11px] font-extrabold text-muted mt-2 opacity-90">
              ${escapeHtml(n.cat || "Notice")}
              • Audience: ${escapeHtml(aud)}
              ${n.start ? " • Start: " + escapeHtml(n.start) : ""}
              ${n.end ? " • End: " + escapeHtml(n.end) : ""}
              • ID: ${n.id}
            </div>
          </div>

          <div class="flex flex-col items-end gap-2 shrink-0">
            <span class="rounded-full px-2.5 py-1 text-[11px] font-black ${pillClassForStatus(st)}">${pill}</span>
            <div class="flex gap-2">
              <button class="rounded-xl px-3 py-2 font-black text-white bg-plan"
                type="button" onclick="editNotice('${n.id}')">Edit</button>
              <button class="rounded-xl px-3 py-2 font-black text-white bg-bad"
                type="button" onclick="deleteNotice('${n.id}')">Delete</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

function resetNoticeForm(){
  document.getElementById("noticeRow").value = "";
  document.getElementById("noticeFormTitle").textContent = "Create new notice";
  document.getElementById("nTitle").value = "";
  document.getElementById("nMsg").value = "";
  document.getElementById("nCat").value = "Notice";
  document.getElementById("nAud").value = "All";
  document.getElementById("nAudCustom").value = "";
  document.getElementById("audCustomWrap").style.display = "none";
  setDefaultNoticeStartNow();
  document.getElementById("nEnd").value = "";
  toast("New notice form ready", 1200);
}

function editNotice(id){
  const n = noticesCache.find(x => String(x.id) === String(id));
  if (!n) return toast("Notice not found.", 2000);

  document.getElementById("noticeRow").value = String(id);
  document.getElementById("noticeFormTitle").textContent = `Edit notice (ID ${id})`;

  document.getElementById("nTitle").value = n.title || "";
  document.getElementById("nMsg").value = n.msg || "";
  document.getElementById("nCat").value = (n.cat || "Notice") || "Notice";

  const aud = (n.aud || "All").trim();
  const known = ["All","Duty Manager","Ops","Maintenance"];
  if (known.includes(aud)){
    document.getElementById("nAud").value = aud;
    document.getElementById("audCustomWrap").style.display = "none";
    document.getElementById("nAudCustom").value = "";
  } else {
    document.getElementById("nAud").value = "custom";
    document.getElementById("audCustomWrap").style.display = "block";
    document.getElementById("nAudCustom").value = aud;
  }

  document.getElementById("nStart").value = fromMysqlDatetime(n.start);
  document.getElementById("nEnd").value = fromMysqlDatetime(n.end);

  toast("Loaded for editing ✅", 1200);
}

/* SAVE NOTICE (DB) */
async function saveNotice(){
  const id = document.getElementById("noticeRow").value.trim();
  const title = document.getElementById("nTitle").value.trim();
  const msg = document.getElementById("nMsg").value.trim();
  const cat = document.getElementById("nCat").value.trim();
  const aud = getAudienceValue();
  const start = toMysqlDatetime(document.getElementById("nStart").value);
  const end = toMysqlDatetime(document.getElementById("nEnd").value);

  if (!title && !msg) return toast("Add at least a Title or Message.", 2400);

  toast(id ? "Saving changes…" : "Creating notice…", 1500);

  await apiPost("/noticeboard_save.php", {
    id: id || null,
    title,
    message: msg,
    category: cat,
    audience: aud,
    start_at: start || null,
    end_at: end || null
  });

  toast("Saved ✅", 1600);
  await loadNoticesManager(false);
  if (!id) resetNoticeForm();
}

/* DELETE NOTICE (DB) */
async function deleteNotice(id){
  if (!confirm(`Delete notice ${id}?`)) return;

  toast("Deleting…", 1500);

  await apiPost("/noticeboard_delete.php", { id: String(id) });

  toast("Deleted ✅", 1600);
  await loadNoticesManager(false);

  if (document.getElementById("noticeRow").value.trim() === String(id)) {
    resetNoticeForm();
  }
}


function deleteNoticeFromForm(){
  const row = document.getElementById("noticeRow").value.trim();
  if (!row) return toast("Load a notice first (Edit).", 2000);
  deleteNotice(row);
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initChemUI);
} else {
  initChemUI();
}

loadPlant().then(() => {
  const aud = document.getElementById("audience");
  if (aud) aud.addEventListener("change", refreshHandover);
}).catch(err => {
  console.error(err);
  toast("Could not load data", 2500);
});


</script>
<script>

// --- Welcome + Auto-logout (idle-based) ---
const IDLE_WARN_MS = 25 * 60 * 1000;   // 25 minutes
const IDLE_LOGOUT_MS = 30 * 60 * 1000; // 30 minutes
let idleWarnTimer = null;
let idleLogoutTimer = null;

function showOverlay(title, msg, btnText="OK", onClick=null){
  const ov = document.getElementById('logoutOverlay');
  const t = document.getElementById('logoutOverlayTitle');
  const m = document.getElementById('logoutOverlayMsg');
  const b = document.getElementById('logoutOverlayBtn');
  if (!ov || !t || !m || !b) return;
  t.textContent = title;
  m.textContent = msg;
  b.textContent = btnText;
  ov.classList.remove('hidden');
  ov.classList.add('flex');
  b.onclick = () => {
    ov.classList.add('hidden');
    ov.classList.remove('flex');
    if (typeof onClick === 'function') onClick();
  };
}

async function doLogout(reasonMsg){
  try { await fetch('/api/auth_logout.php', { method:'POST' }); } catch(e) {}
  sessionStorage.removeItem('staff');
  const gate = document.getElementById('loginGate');
  if (gate) gate.style.display = 'flex';
  showOverlay('Logged out', reasonMsg || 'You have been logged out.', 'Log in', () => {
    const pin = document.getElementById('loginPin');
    if (pin) { pin.value = ''; pin.focus(); }
  });
  const badge = document.getElementById('welcomeBadge');
  if (badge) badge.classList.add('hidden');
}

function scheduleIdleTimers(){
  if (idleWarnTimer) clearTimeout(idleWarnTimer);
  if (idleLogoutTimer) clearTimeout(idleLogoutTimer);

  idleWarnTimer = setTimeout(() => {
    showOverlay('Still there?', 'You will be logged out in 5 minutes due to inactivity.', 'Stay logged in', () => bumpActivity());
  }, IDLE_WARN_MS);

  idleLogoutTimer = setTimeout(() => {
    doLogout('Logged out after 30 minutes of inactivity.');
  }, IDLE_LOGOUT_MS);
}

function bumpActivity(){ scheduleIdleTimers(); }

['mousemove','mousedown','keydown','touchstart','scroll'].forEach(ev => {
  window.addEventListener(ev, bumpActivity, { passive:true });
});

function setWelcome(user){
  const badge = document.getElementById('welcomeBadge');
  if (!badge) return;
  if (user && user.name){
    badge.textContent = `Welcome ${user.name}!`;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

async function refreshWelcomeFromServer(){
  try {
    const r = await fetch('/api/auth_check.php', { cache:'no-store' });
    const ct = (r.headers.get('content-type')||'').toLowerCase();
    if (!r.ok || !ct.includes('application/json')) return null;
    const j = await r.json().catch(()=>null);
    if (j && j.ok && j.user){
      sessionStorage.setItem('staff', JSON.stringify(j.user));
      setWelcome(j.user);
      return j.user;
    }
  } catch(e) {}
  return null;
}

// Hook login success (if loginWithValue exists)
const _origLoginWithValue = window.loginWithValue;
if (typeof _origLoginWithValue === 'function'){
  window.loginWithValue = async function(val){
    const res = await _origLoginWithValue(val);
    const saved = sessionStorage.getItem('staff');
    if (saved){
      try { setWelcome(JSON.parse(saved)); } catch(e){}
    } else {
      await refreshWelcomeFromServer();
    }
    bumpActivity();
    return res;
  };
}

// On load: if already logged in, show welcome + start timers
(function(){
  const saved = sessionStorage.getItem('staff');
  if (saved){
    try { setWelcome(JSON.parse(saved)); } catch(e){}
  }
  refreshWelcomeFromServer().then(u => { if (u) bumpActivity(); });
})();

</script>
</body>
</html>
