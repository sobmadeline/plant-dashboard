<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BRAC Tools - Bookings</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pindan: "#C54B00",
            darkturq: "#004153",
            bg: "#07141a",
            card: "#0b2028",
            line: "#14313b",
            muted: "#cbd5e1",
            good: "#15803d",
            warn: "#ca8a04",
            bad: "#b91c1c",
            plan: "#2563eb",
            teal: "#0f766e"
          }
        }
      }
    }
  </script>
</head>

<body class="m-0 font-sans bg-bg text-slate-50">
  <!-- Header -->
  <header class="bg-darkturq px-4 py-3.5 flex items-center gap-3">
    <div class="w-10 h-10 rounded-xl bg-pindan text-white flex items-center justify-center font-black tracking-wide">LOGO</div>
    <div class="flex-1">
      <div class="text-[18px] font-black leading-tight">Bookings</div>
      <div class="text-[13px] opacity-85 mt-0.5" id="todayLine">Loading date…</div>
    </div>

    <button class="rounded-2xl px-3 py-2 font-black text-white bg-plan"
      type="button" onclick="loadBookings(true)">Refresh</button>
  </header>

  <!-- Add/Edit form -->
  <div class="px-3.5 py-3 bg-[#06181f] border-b border-line">
    <div class="bg-card border border-line rounded-2xl p-3.5">
      <div class="flex items-center justify-between gap-3">
        <div class="font-black text-base" id="formTitle">Add booking</div>
        <button class="rounded-2xl px-3 py-2 font-black text-white bg-teal"
          type="button" onclick="resetForm()">New</button>
      </div>

      <!-- hidden: rowNumber for editing -->
      <input type="hidden" id="rowNumber" value="" />

      <div class="grid grid-cols-4 gap-2.5 mt-3 max-[900px]:grid-cols-2">
        <div>
          <label class="block text-xs font-extrabold text-muted mb-1">Venue</label>
          <select id="bVenue" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base"></select>
        </div>

        <div>
          <label class="block text-xs font-extrabold text-muted mb-1">Start</label>
          <input id="bStart" type="time"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />
        </div>

        <div>
          <label class="block text-xs font-extrabold text-muted mb-1">End</label>
          <input id="bEnd" type="time"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />
        </div>

        <div>
          <label class="block text-xs font-extrabold text-muted mb-1">Lane/Court (optional)</label>
          <input id="bArea" placeholder="e.g., Lane 3 / Court 2"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />
        </div>
      </div>

      <div class="grid grid-cols-4 gap-2.5 mt-2.5 max-[900px]:grid-cols-1">
        <div class="col-span-3 max-[900px]:col-span-1">
          <label class="block text-xs font-extrabold text-muted mb-1">Booking name</label>
          <input id="bName" placeholder="Customer name / Organisation"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />
        </div>

        <div class="flex items-end">
          <button class="w-full bg-pindan rounded-2xl px-3 py-3 text-[16px] font-black text-white"
            type="button" onclick="saveBooking()">Save</button>
        </div>
      </div>

      <div class="grid grid-cols-4 gap-2.5 mt-2.5 max-[900px]:grid-cols-1">
        <div class="col-span-3 max-[900px]:col-span-1">
          <label class="block text-xs font-extrabold text-muted mb-1">Notes (optional)</label>
          <input id="bNotes" placeholder="Optional notes"
            class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />
        </div>

        <div class="flex items-end">
          <button class="w-full bg-bad rounded-2xl px-3 py-3 text-[16px] font-black text-white"
            type="button" onclick="deleteFromForm()">Delete</button>
        </div>
      </div>

      <div class="text-xs font-extrabold text-muted mt-2">
        This writes directly to the <strong>Bookings</strong> tab in Google Sheets.
      </div>
    </div>
  </div>

  <!-- Board -->
  <main class="px-3.5 py-3.5">
    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="flex items-center justify-between gap-3">
        <div class="font-black text-base">Today’s bookings</div>
        <div class="text-xs font-extrabold text-muted" id="countLine">—</div>
      </div>
      <div class="text-xs font-extrabold text-muted mt-2">Tap a booking to edit.</div>
    </div>

    <div id="board" class="grid grid-cols-2 gap-3.5 max-[900px]:grid-cols-1">
      <div class="text-xs font-extrabold text-muted">Loading…</div>
    </div>
  </main>

  <!-- Hidden iframe sink for POST (avoids fetch/CORS issues) -->
  <iframe name="writeSink" style="display:none"></iframe>

  <!-- Toast -->
  <div id="toast"
       class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden max-w-[92vw]
              rounded-2xl border border-line bg-card px-4 py-3 text-sm font-black shadow-lg">
    Toast
  </div>

<script>
/***********************
 * CONFIG
 ***********************/
const VENUES = [
  "Swimming Pool",
  "Stadium",
  "Multipurpose Room",
  "Tennis Courts",
  "Outdoor Courts",
  "Squash Courts",
  "Medland Pavilion",
  "Nipper Roe Oval",
  "Father Mac Oval",
  "Haynes Oval"
];

// ✅ PUT YOUR PUBLISHED BOOKINGS CSV URL HERE (Bookings tab gid)
const BOOKINGS_CSV_URL =
  "PASTE_YOUR_BOOKINGS_CSV_URL_HERE";

// ✅ Your Apps Script write URL
const WRITE_URL =
  "https://script.google.com/macros/s/AKfycbzygxLa5-VSIkWuFe1jWt930bK0kMhrn0QKR8aAKFuF5wSaRagoATKWMfESgQu6OkizHQ/exec";

/***********************
 * SMALL UTILITIES
 ***********************/
function toast(msg, ms=1800){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", ms);
}

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQuotes = false;

  for (let i=0; i<text.length; i++){
    const c = text[i];
    const next = text[i+1];

    if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
    if (c === '"') { inQuotes = !inQuotes; continue; }

    if (!inQuotes && c === ',') { row.push(cur); cur=""; continue; }
    if (!inQuotes && (c === '\n' || c === '\r')) {
      if (c === '\r' && next === '\n') i++;
      row.push(cur); cur="";
      if (row.some(v => v !== "")) rows.push(row);
      row = [];
      continue;
    }
    cur += c;
  }
  row.push(cur);
  if (row.some(v => v !== "")) rows.push(row);
  return rows;
}

function todayYMD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function timeToMin(t){
  if (!t || !/^\d{2}:\d{2}$/.test(t)) return NaN;
  const [hh, mm] = t.split(":").map(Number);
  return hh*60 + mm;
}

/***********************
 * WRITE (POST) HELPER
 ***********************/
function postToAppsScript(params) {
  return new Promise((resolve) => {
    const form = document.createElement("form");
    form.method = "POST";
    form.action = WRITE_URL;
    form.target = "writeSink";

    Object.entries(params).forEach(([k, v]) => {
      if (v === undefined || v === null) return;
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = k;
      input.value = String(v);
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
    form.remove();

    setTimeout(resolve, 900);
  });
}

/***********************
 * STATE + LOAD
 ***********************/
let bookingsCache = []; // {rowNumber, date, venue, start, end, name, area, notes}

async function loadBookings(showToast=false){
  try{
    if (!BOOKINGS_CSV_URL || BOOKINGS_CSV_URL.includes("PASTE_YOUR")) {
      document.getElementById("board").innerHTML =
        `<div class="text-xs font-extrabold text-muted">Paste BOOKINGS_CSV_URL into the file first.</div>`;
      return;
    }

    const res = await fetch(BOOKINGS_CSV_URL, { cache:"no-store" });
    const csv = await res.text();
    const rows = parseCSV(csv);
    const headers = rows[0] || [];
    const idx = (n) => headers.indexOf(n);

    const iDate = idx("Date");
    const iVenue = idx("Venue");
    const iStart = idx("Start");
    const iEnd = idx("End");
    const iName = idx("Name");
    const iArea = idx("Area");
    const iNotes = idx("Notes");

    bookingsCache = rows.slice(1).map((r, i) => ({
      rowNumber: i + 2,
      date: (r[iDate] || "").trim(),
      venue: (r[iVenue] || "").trim(),
      start: (r[iStart] || "").trim(),
      end: (r[iEnd] || "").trim(),
      name: (r[iName] || "").trim(),
      area: (r[iArea] || "").trim(),
      notes: (r[iNotes] || "").trim()
    })).filter(b => b.date && b.venue && b.start && b.end && b.name);

    renderBoard();
    if (showToast) toast("Bookings loaded ✅", 1400);
  } catch(e){
    console.error(e);
    document.getElementById("board").innerHTML =
      `<div class="text-xs font-extrabold text-muted">Could not load bookings (CSV).</div>`;
    if (showToast) toast("Could not load bookings", 2200);
  }
}

/***********************
 * RENDER
 ***********************/
function renderBoard(){
  const today = todayYMD();
  const todayItems = bookingsCache
    .filter(b => b.date === today)
    .slice();

  // sort by start time
  todayItems.sort((a,b) => (timeToMin(a.start) - timeToMin(b.start)) || (timeToMin(a.end) - timeToMin(b.end)));

  document.getElementById("countLine").textContent = `${todayItems.length} booking${todayItems.length===1?"":"s"} today`;

  // group by venue
  const grouped = {};
  VENUES.forEach(v => grouped[v] = []);
  todayItems.forEach(b => {
    if (!grouped[b.venue]) grouped[b.venue] = [];
    grouped[b.venue].push(b);
  });

  const board = document.getElementById("board");
  board.innerHTML = VENUES.map(v => {
    const list = grouped[v] || [];
    return `
      <section class="bg-card border border-line rounded-2xl p-3.5">
        <div class="flex items-center justify-between gap-2">
          <div class="font-black text-[16px]">${esc(v)}</div>
          <div class="text-xs font-extrabold text-muted">${list.length}</div>
        </div>

        <div class="mt-3 space-y-2">
          ${list.length ? list.map(renderRow).join("") : emptyRow()}
        </div>
      </section>
    `;
  }).join("");
}

function emptyRow(){
  return `<div class="rounded-2xl border border-line bg-[#06181f] p-3 text-xs font-extrabold text-muted">
    No bookings listed.
  </div>`;
}

function renderRow(b){
  const area = (b.area || "").trim();
  const notes = (b.notes || "").trim();

  return `
    <button type="button"
      class="w-full text-left rounded-2xl border border-line bg-[#06181f] p-3 hover:opacity-95"
      onclick="editBooking(${b.rowNumber})">

      <div class="font-black text-sm">
        ${esc(b.start)}–${esc(b.end)}
        ${area ? `<span class="ml-2 text-[11px] font-black px-2 py-0.5 rounded-full border border-line">${esc(area)}</span>` : ""}
      </div>

      <div class="text-xs font-extrabold text-muted mt-1 leading-snug break-words">
        ${esc(b.name)}
        ${notes ? `<div class="mt-1 opacity-90">Notes: ${esc(notes)}</div>` : ""}
        <div class="mt-1 opacity-70">Row: ${b.rowNumber}</div>
      </div>
    </button>
  `;
}

/***********************
 * FORM ACTIONS
 ***********************/
function resetForm(){
  document.getElementById("rowNumber").value = "";
  document.getElementById("formTitle").textContent = "Add booking";
  document.getElementById("bVenue").value = VENUES[0];
  document.getElementById("bStart").value = "";
  document.getElementById("bEnd").value = "";
  document.getElementById("bName").value = "";
  document.getElementById("bArea").value = "";
  document.getElementById("bNotes").value = "";
  toast("New booking form ready", 1200);
}

function editBooking(rowNumber){
  const b = bookingsCache.find(x => x.rowNumber === rowNumber);
  if (!b) return toast("Booking not found.", 2000);

  document.getElementById("rowNumber").value = String(rowNumber);
  document.getElementById("formTitle").textContent = `Edit booking (Row ${rowNumber})`;

  document.getElementById("bVenue").value = b.venue || VENUES[0];
  document.getElementById("bStart").value = b.start || "";
  document.getElementById("bEnd").value = b.end || "";
  document.getElementById("bName").value = b.name || "";
  document.getElementById("bArea").value = b.area || "";
  document.getElementById("bNotes").value = b.notes || "";

  toast("Loaded for editing ✅", 1200);
}

async function saveBooking(){
  const row = document.getElementById("rowNumber").value.trim();
  const date = todayYMD(); // this page is “today view” for now
  const venue = document.getElementById("bVenue").value.trim();
  const start = document.getElementById("bStart").value.trim();
  const end = document.getElementById("bEnd").value.trim();
  const name = document.getElementById("bName").value.trim();
  const area = document.getElementById("bArea").value.trim();
  const notes = document.getElementById("bNotes").value.trim();

  if (!venue) return toast("Pick a venue.");
  if (!start || !end) return toast("Add start + end.");
  if (!name) return toast("Add booking name.");
  if (!Number.isFinite(timeToMin(start)) || !Number.isFinite(timeToMin(end))) return toast("Time must be HH:MM.");
  if (timeToMin(end) <= timeToMin(start)) return toast("End must be after start.");

  const action = row ? "updateBooking" : "createBooking";

  toast(row ? "Saving changes…" : "Creating booking…", 1500);

  await postToAppsScript({
    action,
    rowNumber: row,
    date,
    venue,
    start,
    end,
    name,
    area,
    notes
  });

  toast("Saved ✅ (refreshing…)", 1600);
  setTimeout(() => loadBookings(false), 800);
  if (!row) resetForm();
}

async function deleteFromForm(){
  const row = document.getElementById("rowNumber").value.trim();
  if (!row) return toast("Load a booking first (tap one).", 2200);
  if (!confirm(`Delete booking on row ${row}?`)) return;

  toast("Deleting…", 1500);
  await postToAppsScript({ action:"deleteBooking", rowNumber: row });

  toast("Deleted ✅ (refreshing…)", 1600);
  resetForm();
  setTimeout(() => loadBookings(false), 800);
}

/***********************
 * BOOT
 ***********************/
(function init(){
  const d = new Date();
  const label = d.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"short", day:"2-digit" });
  document.getElementById("todayLine").textContent = `Today: ${label} (${todayYMD()})`;

  const sel = document.getElementById("bVenue");
  sel.innerHTML = VENUES.map(v => `<option>${esc(v)}</option>`).join("");

  resetForm();
  loadBookings(false);
})();
</script>
</body>
</html>
