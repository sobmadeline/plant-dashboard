<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plant Status – Update</title>
  <style>
    :root{
      --pindan:#C54B00;
      --dark-turq:#004153;
      --bg:#07141a;
      --card:#0b2028;
      --text:#f8fafc;
      --muted:#cbd5e1;
      --line:#14313b;
      --good:#15803d;
      --warn:#ca8a04;
      --bad:#b91c1c;
      --plan:#2563eb;
      --teal:#0f766e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    header{
      background:var(--dark-turq);
      padding:14px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      width:40px;height:40px;border-radius:10px;
      background:var(--pindan);color:white;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.04em;
    }
    .h1{font-size:18px;font-weight:900;line-height:1.1}
    .h2{font-size:13px;opacity:.85;margin-top:2px}

    .tabs{display:flex;gap:10px;padding:10px 14px;background:#06181f}
    .tab{
      flex:1;border:1px solid var(--line);background:var(--card);color:var(--text);
      padding:12px;border-radius:14px;font-weight:900;font-size:16px
    }
    .tab.active{border-color:var(--pindan);box-shadow:0 0 0 2px rgba(197,75,0,.35)}

    .wrap{padding:14px 14px 20px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
    }
    label{display:block;font-size:13px;color:var(--muted);font-weight:800;margin:10px 0 6px}
    select, input, textarea{
      width:100%; padding:12px 12px;
      border-radius:12px; border:1px solid var(--line);
      background:#06181f; color:var(--text);
      font-size:16px;
    }
    textarea{min-height:90px; resize:vertical}

    .btnrow{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .btn{
      border:none;border-radius:14px;padding:14px 12px;
      font-size:16px;font-weight:900;color:white;cursor:pointer
    }
    .b-good{background:var(--good)}
    .b-warn{background:var(--warn)}
    .b-bad{background:var(--bad)}
    .b-plan{background:var(--plan)}
    .btn.selected{outline:3px solid #f8fafc;box-shadow:0 0 0 3px rgba(197,75,0,.55)}

    .submit{
      width:100%; margin-top:12px;
      background:var(--pindan);
      border:none;border-radius:14px;
      padding:14px 12px;
      color:white;font-weight:900;font-size:17px;
      cursor:pointer;
    }
    .submit.secondary{background:var(--plan)}
    .submit.teal{background:var(--teal)}

    .small{font-size:12px;color:var(--muted);margin-top:8px;font-weight:800}

    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-weight:900;font-size:12px;letter-spacing:.04em}

    .noticeBox{border:1px solid var(--line);border-radius:14px;background:#06181f;padding:10px 12px;margin-top:10px}
    .state{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#06181f;
      font-weight:900;
      line-height:1.25;
    }
    .state.active{border-color:var(--pindan);background:rgba(197,75,0,.12)}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:14px;background:#05212a;border:1px solid var(--line);
      padding:12px 14px;border-radius:14px;max-width:92vw;
      display:none;font-weight:900;
      z-index:999;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 540px){
      .grid2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">LOGO</div>
    <div>
      <div class="h1">Plant Dashboard</div>
      <div class="h2">Aquatic Facility – 25m Pool</div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" id="btnUpdate" type="button" onclick="switchTab('update')">Update</button>
    <button class="tab" id="btnHandover" type="button" onclick="switchTab('handover')">Handover</button>
    <button class="tab" id="btnChemical" type="button" onclick="switchTab('chemical')">Chemical</button>
    <button class="tab" id="btnClock" type="button" onclick="switchTab('clock')">Clock In/Out</button>
  </div>

  <!-- UPDATE TAB -->
  <div id="tab-update" class="wrap">
    <div class="card">
      <div style="font-weight:900;font-size:16px">Quick Update</div>

      <label>Component</label>
      <select id="component"></select>

      <label>Status</label>
      <div class="btnrow" id="statusButtons">
        <button class="btn b-good" type="button" data-status="Operational">Operational</button>
        <button class="btn b-warn" type="button" data-status="Degraded">Degraded</button>
        <button class="btn b-bad" type="button" data-status="Offline">Offline</button>
        <button class="btn b-plan" type="button" data-status="Planned Maintenance">Planned</button>
      </div>

      <div class="small" id="chosenStatus">Selected status: —</div>

      <label>Condition</label>
      <select id="condition">
        <option value="">(optional)</option>
        <option>Normal</option>
        <option>Noise / Vibration</option>
        <option>Reduced Flow</option>
        <option>Pressure Issue</option>
        <option>Leak Present</option>
        <option>Electrical Fault</option>
        <option>Under Investigation</option>
      </select>

      <label>Issue Summary</label>
      <input id="summary" placeholder="e.g., Bearing noise on startup" />

      <button class="submit" type="button" onclick="submitUpdate()">Save Update</button>
      <div class="small">Tip: tap a status button before saving.</div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="font-weight:900;font-size:16px">Current Status (read-only)</div>
        <span class="pill">Auto refresh</span>
      </div>
      <div id="statusList" class="small" style="margin-top:10px">Loading…</div>
    </div>
  </div>

  <!-- HANDOVER TAB -->
  <div id="tab-handover" class="wrap" style="display:none">
    <div class="card">
      <div style="font-weight:900;font-size:18px;margin-bottom:8px">Shift Handover</div>

      <div id="handoverState" class="state">Loading handover…</div>

      <div class="noticeBox" style="margin-top:12px">
        <div style="font-weight:900">Plant summary</div>
        <div class="small">Non-operational / attention required</div>
        <div id="plantSummary"></div>
      </div>

      <label style="margin-top:12px">Viewing notices for</label>
      <select id="audience">
        <option>All</option>
        <option>Duty Manager</option>
        <option>Ops</option>
        <option>Maintenance</option>
      </select>

      <div class="noticeBox" style="margin-top:10px">
        <div style="font-weight:900">Relevant notices</div>
        <div id="handoverNotices"></div>
      </div>

      <label style="margin-top:12px">New handover message</label>
      <textarea id="handoverMsg" placeholder="Add context or actions for the next shift (optional if the summary above is sufficient)"></textarea>

      <button class="submit" type="button" onclick="setHandover()">Set handover</button>
      <button class="submit secondary" type="button" style="margin-top:8px" onclick="ackHandover()">Acknowledge handover</button>

      <div class="small" style="margin-top:10px">
        Tip: Use handover only for items that must carry into the next shift.
      </div>
    </div>
  </div>

  <!-- CHEMICAL TAB -->
  <div id="tab-chemical" class="wrap" style="display:none">
    <div class="card">
      <div style="font-weight:900;font-size:18px;margin-bottom:8px">Chemical calculations</div>
      <div class="small">Based on BRAC Aquatic Chemical Calculator (Excel). Default volume is 1,000,000 L.</div>

      <label>Pool volume</label>
      <div class="grid2">
        <input id="chemVol" inputmode="decimal" placeholder="1000" value="1000" />
        <select id="chemVolUnit">
          <option value="kL" selected>kL</option>
          <option value="L">L</option>
        </select>
      </div>
      <div class="small">1000 kL = 1,000,000 L</div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:16px;margin-bottom:6px">Current levels</div>

      <label>Free Chlorine (ppm)</label>
      <input id="curFC" inputmode="decimal" placeholder="e.g., 3.8" />

      <label>pH</label>
      <input id="curPH" inputmode="decimal" placeholder="e.g., 7.5" />

      <label>Alkalinity (ppm)</label>
      <input id="curALK" inputmode="decimal" placeholder="e.g., 120" />

      <label>Cyanuric Acid (ppm)</label>
      <input id="curCYA" inputmode="decimal" placeholder="e.g., 45" />

      <label>Calcium Hardness (ppm)</label>
      <input id="curCH" inputmode="decimal" placeholder="e.g., 120" />
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:16px;margin-bottom:6px">Targets</div>

      <label>Free Chlorine target (ppm)</label>
      <input id="tFC" inputmode="decimal" value="6" />

      <label>pH target</label>
      <input id="tPH" inputmode="decimal" value="7.5" />

      <label>Alkalinity target (ppm)</label>
      <input id="tALK" inputmode="decimal" value="90" />

      <label>Cyanuric Acid target (ppm)</label>
      <input id="tCYA" inputmode="decimal" value="45" />

      <label>Calcium Hardness target (ppm)</label>
      <input id="tCH" inputmode="decimal" value="120" />

      <button class="submit" type="button" onclick="runChem()">Calculate</button>
      <button class="submit secondary" type="button" style="margin-top:8px" onclick="copyChemNotes(false)">Copy to notes</button>
      <button class="submit teal" type="button" style="margin-top:8px" onclick="copyChemNotes(true)">Copy + add to handover</button>

      <div class="small">Tip: “Copy + add to handover” appends the dosing block into the Handover message box.</div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:16px;margin-bottom:6px">Dose results</div>
      <div id="chemResults" class="small">Enter values and press Calculate.</div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:16px;margin-bottom:6px">Safety reminders</div>
      <div class="small">
        • Follow facility SOP + SDS for handling/dosing.<br>
        • Add chemical to water where applicable (never water to chemical).<br>
        • Don’t exceed max dosing limits if your SOP has them.<br>
        • Record dosing where required.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>

window.addEventListener("error", (ev) => {
  const msg = ev && ev.message ? ev.message : "Unknown script error";
  toast("JS ERROR: " + msg, 6000);
});

<!-- CLOCK TAB -->
<div id="tab-clock" class="wrap" style="display:none">
  <div class="card">
    <div style="font-weight:900;font-size:18px;margin-bottom:8px">Clock in / out</div>
    <div class="small">ZoomShift time clock</div>

    <button class="submit" type="button" onclick="openClockSameTab()">Open Time Clock (same tab)</button>
    <button class="submit secondary" type="button" style="margin-top:8px" onclick="openClockNewTab()">Open Time Clock (new tab)</button>

    <div class="small" style="margin-top:10px">
      If the embedded view below stays blank, use the buttons above (ZoomShift may block embedding).
    </div>
  </div>

  <div class="card">
    <div style="font-weight:900;font-size:16px;margin-bottom:6px">Embedded (if supported)</div>
    <div class="small" style="margin-bottom:8px">Best for wall/iPad kiosk use, but depends on ZoomShift settings.</div>

    <div style="border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#06181f">
      <iframe
        id="clockFrame"
        title="ZoomShift Time Clock"
        src="https://app.zoomshift.com/clm058b/time_clock"
        style="width:100%;height:70vh;border:0"
        referrerpolicy="no-referrer-when-downgrade"
      ></iframe>
    </div>
  </div>
</div>

  // === LIVE DATA URLS ===
  const PLANT_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=0&single=true&output=csv";

  const NOTICE_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=684780974&single=true&output=csv";

  const HANDOVER_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=871823190&single=true&output=csv";

  // Your Apps Script web app endpoint (WRITE)
  const WRITE_URL =
    "https://script.google.com/macros/s/AKfycbzAQ3ZDxtE-WHc-HxDIFbbDMPJMqyXf6K1qtt5pCaQBPPgA1gvLid8v7gvx9jnerBHJlg/exec";

  let cached = [];            // Plant items cached after load()
  let selectedStatus = "";    // Set by status buttons
  let chemLast = null;        // Last chemical calculation snapshot

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function toast(msg, ms=1800){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=> t.style.display="none", ms);
  }

  function parseCSV(text){
    const rows = [];
    let row = [], cur = "", inQuotes = false;

    for (let i=0; i<text.length; i++){
      const c = text[i];
      const next = text[i+1];

      if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
      if (c === '"') { inQuotes = !inQuotes; continue; }

      if (!inQuotes && c === ',') { row.push(cur); cur=""; continue; }
      if (!inQuotes && (c === '\n' || c === '\r')) {
        if (c === '\r' && next === '\n') i++;
        row.push(cur); cur="";
        if (row.some(v => v !== "")) rows.push(row);
        row = [];
        continue;
      }
      cur += c;
    }
    row.push(cur);
    if (row.some(v => v !== "")) rows.push(row);
    return rows;
  }

  function rankStatus(s){
    s = (s || "").trim().toLowerCase();
    if (s === "offline") return 1;
    if (s === "degraded") return 2;
    if (s === "planned maintenance") return 3;
    return 4;
  }

  function isActiveNotice(startStr, endStr){
    const now = new Date();
    const start = startStr ? new Date(startStr) : null;
    const end = endStr ? new Date(endStr) : null;
    const okStart = !startStr || (!isNaN(start) && start <= now);
    const okEnd = !endStr || (!isNaN(end) && end >= now);
    return okStart && okEnd;
  }

  function audienceMatches(audienceCell, selected){
    const raw = (audienceCell || "").trim();
    if (!raw || raw.toLowerCase() === "all") return true;
    const parts = raw.split(",").map(x => x.trim().toLowerCase()).filter(Boolean);
    return parts.includes(String(selected).trim().toLowerCase()) || parts.includes("all");
  }

  async function loadPlant(){
    const res = await fetch(PLANT_CSV_URL, { cache:"no-store" });
    const csv = await res.text();
    const data = parseCSV(csv);
    const headers = data[0];
    const idx = (n) => headers.indexOf(n);

    const iId = idx("Component ID");
    const iName = idx("Component Name");
    const iStatus = idx("Status");
    const iIssue = idx("Issue Summary");

    const items = data.slice(1).map(r => ({
      id: (r[iId] || "").trim(),
      name: (r[iName] || "").trim(),
      status: (r[iStatus] || "").trim(),
      issue: (r[iIssue] || "").trim()
    })).filter(x => x.id && x.name);

    cached = items;

    // Populate dropdown
    const sel = document.getElementById("component");
    sel.innerHTML = items.map(x =>
      `<option value="${escapeHtml(x.id)}">${escapeHtml(x.name)} (${escapeHtml(x.id)})</option>`
    ).join("");

    // Render read-only list (compact)
    const list = items
      .slice()
      .sort((a,b) => rankStatus(a.status) - rankStatus(b.status) || a.name.localeCompare(b.name))
      .map(it => `• ${it.name}: ${it.status || "Operational"}`)
      .join("<br>");

    document.getElementById("statusList").innerHTML = list || "No data";
  }

  function wireStatusButtons(){
    document.querySelectorAll("#statusButtons .btn").forEach(btn => {
      btn.addEventListener("click", () => {
        selectedStatus = btn.dataset.status || "";
        document.getElementById("chosenStatus").textContent = "Selected status: " + selectedStatus;

        document.querySelectorAll("#statusButtons .btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
      });
    });
  }

  async function submitUpdate(){
    try{
      const componentId = document.getElementById("component").value;
      const condition = document.getElementById("condition").value;
      const summary = document.getElementById("summary").value;

      if (!componentId) return toast("Pick a component first.");
      if (!selectedStatus) return toast("Tap a Status button first.");

      const body = new URLSearchParams({
        action: "updateComponent",
        componentId,
        status: selectedStatus,
        condition,
        summary
      });

      toast("Saving…", 1500);
      const res = await fetch(WRITE_URL, { method:"POST", body });
      const text = await res.text();

      if (!res.ok || !String(text).startsWith("OK")) {
        console.error(text);
        return toast("Save failed. Check connection / script.", 3000);
      }

      toast(text, 2000);
      document.getElementById("summary").value = "";
      await loadPlant();
    } catch(e){
      console.error(e);
      toast("Save failed (network/browser error)", 3200);
    }
  }

  function buildPlantSummary(){
    const nonOp = cached
      .filter(it => rankStatus(it.status) <= 3 && (it.status || "").trim().toLowerCase() !== "operational")
      .sort((a,b) => rankStatus(a.status) - rankStatus(b.status));

    if (!nonOp.length){
      return `<ul class="small" style="margin:8px 0 0 18px"><li>No non-operational items</li></ul>`;
    }

    return `<ul class="small" style="margin:8px 0 0 18px">` + nonOp.map(it =>
      `<li><strong>${escapeHtml(it.name)}</strong> — ${escapeHtml(it.status)}${it.issue ? " • " + escapeHtml(it.issue) : ""}</li>`
    ).join("") + `</ul>`;
  }

  async function loadNoticesForHandover(){
    const selected = document.getElementById("audience").value;

    const res = await fetch(NOTICE_CSV_URL, { cache:"no-store" });
    const csv = await res.text();
    const rows = parseCSV(csv);
    const headers = rows[0];
    const idx = (n) => headers.indexOf(n);

    const iTitle = idx("Title");
    const iMsg = idx("Message");
    const iStart = idx("Start");
    const iEnd = idx("End");
    const iAud = idx("Audience");

    const items = rows.slice(1).map(r => ({
      title: (r[iTitle] || "").trim(),
      msg: (r[iMsg] || "").trim(),
      start: (r[iStart] || "").trim(),
      end: (r[iEnd] || "").trim(),
      aud: (r[iAud] || "").trim()
    })).filter(x => x.title || x.msg);

    const active = items
      .filter(n => isActiveNotice(n.start, n.end))
      .filter(n => audienceMatches(n.aud, selected))
      .slice(0, 6);

    if (!active.length){
      return `<ul class="small" style="margin:8px 0 0 18px"><li>No active notices for ${escapeHtml(selected)}</li></ul>`;
    }

    return `<ul class="small" style="margin:8px 0 0 18px">` + active.map(n =>
      `<li><strong>${escapeHtml(n.title || "Notice")}</strong>${n.msg ? " — " + escapeHtml(n.msg) : ""}</li>`
    ).join("") + `</ul>`;
  }

  async function refreshHandover(){
    try{
      const res = await fetch(HANDOVER_CSV_URL, { cache:"no-store" });
      const csv = await res.text();
      const data = parseCSV(csv);
      const headers = data[0];
      const row = data[1] || [];
      const idx = (n) => headers.indexOf(n);

      const active = (row[idx("Active")] || "").trim().toLowerCase();
      const msg = (row[idx("Message")] || "").trim();
      const created = (row[idx("Created")] || "").trim();
      const ack = (row[idx("Acknowledged")] || "").trim().toLowerCase();

      const state = document.getElementById("handoverState");
      if (active === "yes" && ack !== "yes" && msg){
        state.classList.add("active");
        state.innerHTML = `Active handover<div class="small" style="margin-top:6px">${escapeHtml(msg)}<br><span style="opacity:.85">Created: ${escapeHtml(created)}</span></div>`;
      } else {
        state.classList.remove("active");
        state.innerHTML = `No active handover<div class="small" style="margin-top:6px;opacity:.9">Nothing pending for the next shift.</div>`;
      }

      document.getElementById("plantSummary").innerHTML = buildPlantSummary();
      document.getElementById("handoverNotices").innerHTML = await loadNoticesForHandover();
    } catch(e){
      console.error(e);
      document.getElementById("handoverState").textContent = "Could not load handover.";
      document.getElementById("plantSummary").innerHTML = "";
      document.getElementById("handoverNotices").innerHTML = "";
    }
  }

  async function setHandover(){
    const message = document.getElementById("handoverMsg").value.trim();
    if (!message) return toast("Enter a short handover message first.");

    const body = new URLSearchParams({ action:"setHandover", message });
    toast("Setting handover…", 1500);

    const res = await fetch(WRITE_URL, { method:"POST", body });
    const text = await res.text();

if (!String(text).startsWith("OK")) {
  console.error(text);
  return toast(text, 4500); // show real server error
}

    toast("Handover set ✅", 2000);
    document.getElementById("handoverMsg").value = "";
    await refreshHandover();
  }

  async function ackHandover(){
    const body = new URLSearchParams({ action:"ackHandover" });
    toast("Acknowledging…", 1500);

    const res = await fetch(WRITE_URL, { method:"POST", body });
    const text = await res.text();

if (!String(text).startsWith("OK")) {
  console.error(text);
  return toast(text, 4500);
}

    toast("Acknowledged ✅", 2000);
    await refreshHandover();
  }

function switchTab(which){
  const panels = {
    update: document.getElementById("tab-update"),
    handover: document.getElementById("tab-handover"),
    chemical: document.getElementById("tab-chemical"),
    clock: document.getElementById("tab-clock"), // new
  };

  const buttons = {
    update: document.getElementById("btnUpdate"),
    handover: document.getElementById("btnHandover"),
    chemical: document.getElementById("btnChemical"),
    clock: document.getElementById("btnClock"), // new
  };

  // If someone clicks a tab that doesn't exist, don’t crash.
  if (!panels[which]) {
    toast(`ERROR: Tab "${which}" not found in HTML`, 4500);
    return;
  }

  Object.keys(panels).forEach(k => {
    if (panels[k]) panels[k].style.display = (k === which) ? "block" : "none";
    if (buttons[k]) buttons[k].classList.toggle("active", k === which);
  });

  if (which === "handover") {
    // Only call if the function exists
    if (typeof refreshHandover === "function") refreshHandover();
  }
}


  // ===== CHEM CALC (Excel-matching rules) =====
  function num(id){
    const v = document.getElementById(id)?.value;
    const n = parseFloat(String(v ?? "").replace(/,/g,"").trim());
    return Number.isFinite(n) ? n : NaN;
  }

  function roundup(x, decimals){
    if (!Number.isFinite(x)) return NaN;
    const m = Math.pow(10, decimals);
    return Math.ceil(x * m) / m;
  }

  function poolLitres(){
    const v = num("chemVol");
    const unit = document.getElementById("chemVolUnit").value;
    if (!Number.isFinite(v) || v <= 0) return NaN;
    return unit === "kL" ? v * 1000 : v;
  }

  function pureKg(deltaPpm, volL){
    return (deltaPpm * volL) / 1000000;
  }

  function fmt(x, suffix){
    if (!Number.isFinite(x)) return "—";
    return `${x.toLocaleString(undefined,{maximumFractionDigits:2})}${suffix||""}`;
  }

  function line(title, value){
    return `<div style="margin:6px 0"><strong>${escapeHtml(title)}:</strong> ${escapeHtml(value)}</div>`;
  }

  function nowStamp(){
    const d = new Date();
    return d.toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }
  }

  function buildChemNotes(){
    if (!chemLast) return "";

    const lines = [];
    lines.push(`CHEM CALC (${chemLast.volumeKL} kL)`);
    if (chemLast.fc){
      lines.push(`FC: ${chemLast.fc.cur} → ${chemLast.fc.tgt} | Dose: ${chemLast.fc.hypoL} L sodium hypo (10.42%) | ${fmt(chemLast.fc.calHypoKg," kg")} cal hypo (62.5%)`);
    }
    if (chemLast.ph){
      lines.push(`pH: ${chemLast.ph.cur} → ${chemLast.ph.tgt} | Dose: ${chemLast.ph.acidL} L sulphuric acid (Excel rule)`);
    }
    if (chemLast.alk){
      lines.push(`ALK: ${chemLast.alk.cur} → ${chemLast.alk.tgt} | Dose: ${fmt(chemLast.alk.bicarbKg," kg")} sodium bicarb`);
    }
    if (chemLast.cya){
      lines.push(`CYA: ${chemLast.cya.cur} → ${chemLast.cya.tgt} | Dose: ${chemLast.cya.cyaKg} kg cyanuric acid`);
    }
    if (chemLast.ch){
      lines.push(`CH: ${chemLast.ch.cur} → ${chemLast.ch.tgt} | Dose: ${chemLast.ch.caCl2Kg} kg calcium chloride (91%)`);
    }
    if (chemLast.thioKg !== null){
      lines.push(`If reducing FC: Thiosulphate (Excel rule): ${fmt(chemLast.thioKg," kg")}`);
    }
    lines.push(`Timestamp: ${nowStamp()}`);
    return lines.join("\n");
  }

  async function copyChemNotes(addToHandover=false){
    if (!chemLast) return toast("Run Calculate first.", 2000);

    const text = buildChemNotes();
    const ok = await copyText(text);

    if (addToHandover){
      switchTab("handover");
      const box = document.getElementById("handoverMsg");
      if (box){
        box.value = (box.value.trim() ? box.value.trim() + "\n\n" : "") + text;
      }
      await refreshHandover();
    }

    toast(ok ? "Copied ✅" : "Copy failed (browser)", 2200);
  }

  function runChem(){
    const V = poolLitres();
    if (!Number.isFinite(V)) return toast("Enter a valid pool volume.", 2200);

    const volumeKL = Math.round(V / 1000);

    // Current
    const curFC = num("curFC");
    const curPH = num("curPH");
    const curALK = num("curALK");
    const curCYA = num("curCYA");
    const curCH = num("curCH");

    // Targets
    const tFC = num("tFC");
    const tPH = num("tPH");
    const tALK = num("tALK");
    const tCYA = num("tCYA");
    const tCH = num("tCH");

    let out = "";
    const snap = { volumeKL, fc:null, ph:null, alk:null, cya:null, ch:null, thioKg:null };

    // Chlorine (shows both products)
    if (Number.isFinite(curFC) && Number.isFinite(tFC)) {
      const d = tFC - curFC;
      const Fkg = pureKg(d, V);

      // Sodium Hypochlorite: 10.42%, density 1.2 kg/L, round up to whole L
      const strengthHypo = 10.42 / 100;
      const densityHypo = 1.2;
      const Lhypo = (Fkg / strengthHypo) / densityHypo;
      const LhypoOut = roundup(Math.max(Lhypo, 0), 0);

      // Calcium Hypochlorite: 62.5% (kg)
      const strengthCal = 62.5 / 100;
      const kgCal = Math.max(Fkg / strengthCal, 0);

      out += `<div style="margin-top:10px;font-weight:900">Chlorine</div>`;
      out += line("Sodium Hypochlorite (10.42%)", fmt(LhypoOut, " L"));
      out += line("Calcium Hypochlorite (62.5%)", fmt(kgCal, " kg"));

      // Thiosulphate (Excel rule)
      const thioKg = Math.max((curFC - tFC) / 1, 0);
      snap.thioKg = thioKg;

      snap.fc = { cur: curFC, tgt: tFC, hypoL: LhypoOut, calHypoKg: kgCal };
    } else {
      out += `<div style="margin-top:10px;font-weight:900">Chlorine</div>`;
      out += `<div class="small">Enter current + target Free Chlorine to calculate.</div>`;
      snap.thioKg = null;
    }

    // pH / Sulphuric Acid (Excel rule)
    if (Number.isFinite(curPH) && Number.isFinite(tPH)) {
      const steps = Math.max((curPH - tPH) / 0.1, 0);
      const acidL = roundup(steps * 10 * V / 1000000, 1);

      out += `<div style="margin-top:14px;font-weight:900">pH</div>`;
      out += line("Sulphuric Acid (Excel rule)", fmt(acidL, " L"));

      snap.ph = { cur: curPH, tgt: tPH, acidL };
    } else {
      out += `<div style="margin-top:14px;font-weight:900">pH</div>`;
      out += `<div class="small">Enter current + target pH to calculate.</div>`;
    }

    // Alkalinity / Sodium Bicarbonate
    if (Number.isFinite(curALK) && Number.isFinite(tALK)) {
      const d = tALK - curALK;
      const kg = Math.max(pureKg(d, V), 0);

      out += `<div style="margin-top:14px;font-weight:900">Alkalinity</div>`;
      out += line("Sodium Bicarbonate", fmt(kg, " kg"));

      snap.alk = { cur: curALK, tgt: tALK, bicarbKg: kg };
    } else {
      out += `<div style="margin-top:14px;font-weight:900">Alkalinity</div>`;
      out += `<div class="small">Enter current + target alkalinity to calculate.</div>`;
    }

    // Cyanuric Acid (round up to whole kg)
    if (Number.isFinite(curCYA) && Number.isFinite(tCYA)) {
      const d = tCYA - curCYA;
      const kg = roundup(Math.max(pureKg(d, V), 0), 0);

      out += `<div style="margin-top:14px;font-weight:900">Cyanuric Acid</div>`;
      out += line("Cyanuric Acid", fmt(kg, " kg"));

      snap.cya = { cur: curCYA, tgt: tCYA, cyaKg: kg };
    } else {
      out += `<div style="margin-top:14px;font-weight:900">Cyanuric Acid</div>`;
      out += `<div class="small">Enter current + target CYA to calculate.</div>`;
    }

    // Calcium Hardness / Calcium Chloride (91%) round up to 0.1 kg
    if (Number.isFinite(curCH) && Number.isFinite(tCH)) {
      const d = tCH - curCH;
      const Fkg = pureKg(d, V);
      const strength = 0.91;
      const kg = roundup(Math.max(Fkg / strength, 0), 1);

      out += `<div style="margin-top:14px;font-weight:900">Calcium Hardness</div>`;
      out += line("Calcium Chloride (91%)", fmt(kg, " kg"));

      snap.ch = { cur: curCH, tgt: tCH, caCl2Kg: kg };
    } else {
      out += `<div style="margin-top:14px;font-weight:900">Calcium Hardness</div>`;
      out += `<div class="small">Enter current + target calcium hardness to calculate.</div>`;
    }

    document.getElementById("chemResults").innerHTML = out;
    chemLast = snap;
    toast("Calculated ✅", 1200);
  }

  // Boot
  wireStatusButtons();
  loadPlant().then(() => {
    const aud = document.getElementById("audience");
    if (aud) aud.addEventListener("change", refreshHandover);
  }).catch(err => {
    console.error(err);
    toast("Could not load sheet data", 2500);
  });

  const ZOOMSHIFT_CLOCK_URL = "https://app.zoomshift.com/clm058b/time_clock";

function openClockSameTab(){
  window.location.href = ZOOMSHIFT_CLOCK_URL;
}

function openClockNewTab(){
  window.open(ZOOMSHIFT_CLOCK_URL, "_blank", "noopener");
}

</script>
</body>
</html>
