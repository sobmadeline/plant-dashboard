<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BRAC Tools – Centre Management</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pindan: "#C54B00",
            darkturq: "#004153",
            bg: "#07141a",
            card: "#0b2028",
            line: "#14313b",
            muted: "#cbd5e1",
            good: "#15803d",
            warn: "#ca8a04",
            bad: "#b91c1c",
            plan: "#2563eb",
            teal: "#0f766e"
          }
        }
      }
    }
  </script>

  <!-- Tiny shim to preserve your existing JS class toggles -->
  <style>
    .tab.active{ border-color:#C54B00 !important; box-shadow:0 0 0 2px rgba(197,75,0,.35) !important; }
    .btn.selected{ outline:3px solid #f8fafc; box-shadow:0 0 0 3px rgba(197,75,0,.55); }
  </style>
</head>

<body class="m-0 font-sans bg-bg text-slate-50">
  <!-- Header -->
  <header class="bg-darkturq px-4 py-3.5 flex items-center gap-3">
    <div class="w-10 h-10 rounded-xl bg-pindan text-white flex items-center justify-center font-black tracking-wide">LOGO</div>
    <div>
      <div class="text-[18px] font-black leading-tight">Plant Dashboard</div>
      <div class="text-[13px] opacity-85 mt-0.5">Aquatic Facility – 25m Pool</div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="flex gap-2.5 px-3.5 py-2.5 bg-[#06181f]">
    <button class="tab active flex-1 rounded-2xl border border-line bg-card px-3 py-3 font-black text-base"
      id="btnUpdate" type="button" onclick="switchTab('update')">Update</button>

    <button class="tab flex-1 rounded-2xl border border-line bg-card px-3 py-3 font-black text-base"
      id="btnHandover" type="button" onclick="switchTab('handover')">Handover</button>

    <button class="tab flex-1 rounded-2xl border border-line bg-card px-3 py-3 font-black text-base"
      id="btnChemical" type="button" onclick="switchTab('chemical')">Chemical</button>

  </div>

  <!-- UPDATE TAB -->
  <div id="tab-update" class="px-3.5 pt-3.5 pb-5">
    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base">Quick Update</div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Component</label>
      <select id="component" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base"></select>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-2">Status</label>
      <div class="grid grid-cols-2 gap-2.5 mt-2.5" id="statusButtons">
        <button class="btn rounded-2xl px-3 py-3 font-black text-white bg-good" type="button" data-status="Operational">Operational</button>
        <button class="btn rounded-2xl px-3 py-3 font-black text-white bg-warn" type="button" data-status="Degraded">Degraded</button>
        <button class="btn rounded-2xl px-3 py-3 font-black text-white bg-bad" type="button" data-status="Offline">Offline</button>
        <button class="btn rounded-2xl px-3 py-3 font-black text-white bg-plan" type="button" data-status="Planned Maintenance">Planned</button>
      </div>

      <div class="text-xs font-extrabold text-muted mt-2" id="chosenStatus">Selected status: —</div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Condition</label>
      <select id="condition" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base">
        <option value="">(optional)</option>
        <option>Normal</option>
        <option>Noise / Vibration</option>
        <option>Reduced Flow</option>
        <option>Pressure Issue</option>
        <option>Leak Present</option>
        <option>Electrical Fault</option>
        <option>Under Investigation</option>
      </select>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Issue Summary</label>
      <input id="summary" placeholder="e.g., Bearing noise on startup"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

      <button class="w-full mt-3 bg-pindan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="submitUpdate()">Save Update</button>

      <div class="text-xs font-extrabold text-muted mt-2">Tip: tap a status button before saving.</div>
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="flex items-center justify-between gap-2.5">
        <div class="font-black text-base">Current Status (read-only)</div>
        <span class="inline-block rounded-full border border-line px-2.5 py-1 text-xs font-black tracking-wide">Auto refresh</span>
      </div>
      <div id="statusList" class="text-xs font-extrabold text-muted mt-3">Loading…</div>
    </div>
  </div>

  <!-- HANDOVER TAB -->
  <div id="tab-handover" class="px-3.5 pt-3.5 pb-5" style="display:none">
    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-[18px] mb-2">Shift Handover</div>

      <div id="handoverState"
        class="rounded-2xl border border-line bg-[#06181f] p-3 font-black leading-snug">
        Loading handover…
      </div>

      <div class="mt-3 rounded-2xl border border-line bg-[#06181f] p-3">
        <div class="font-black">Plant summary</div>
        <div class="text-xs font-extrabold text-muted mt-1">Non-operational / attention required</div>
        <div id="plantSummary" class="mt-2"></div>
      </div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Viewing notices for</label>
      <select id="audience" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base">
        <option>All</option>
        <option>Duty Manager</option>
        <option>Ops</option>
        <option>Maintenance</option>
      </select>

      <div class="mt-3 rounded-2xl border border-line bg-[#06181f] p-3">
        <div class="font-black">Relevant notices</div>
        <div id="handoverNotices" class="mt-2"></div>
      </div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">New handover message</label>
      <textarea id="handoverMsg"
        class="w-full min-h-[110px] rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400"
        placeholder="Add context or actions for the next shift (optional if the summary above is sufficient)"></textarea>

      <button class="w-full mt-3 bg-pindan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="setHandover()">Set handover</button>

      <button class="w-full mt-2 bg-plan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="ackHandover()">Acknowledge handover</button>

      <div class="text-xs font-extrabold text-muted mt-2">
        Tip: Use handover only for items that must carry into the next shift.
      </div>
    </div>
  </div>

  <!-- CHEMICAL TAB -->
  <div id="tab-chemical" class="px-3.5 pt-3.5 pb-5" style="display:none">
    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-[18px] mb-2">Chemical calculations</div>
      <div class="text-xs font-extrabold text-muted">Based on BRAC Aquatic Chemical Calculator (Excel). Default volume is 1,000,000 L.</div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Pool volume</label>
      <div class="grid grid-cols-2 gap-2.5">
        <input id="chemVol" inputmode="decimal" placeholder="1000" value="1000"
          class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />
        <select id="chemVolUnit" class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base">
          <option value="kL" selected>kL</option>
          <option value="L">L</option>
        </select>
      </div>
      <div class="text-xs font-extrabold text-muted mt-2">1000 kL = 1,000,000 L</div>
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base mb-1.5">Current levels</div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Free Chlorine (ppm)</label>
      <input id="curFC" inputmode="decimal" placeholder="e.g., 3.8"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">pH</label>
      <input id="curPH" inputmode="decimal" placeholder="e.g., 7.5"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Alkalinity (ppm)</label>
      <input id="curALK" inputmode="decimal" placeholder="e.g., 120"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Cyanuric Acid (ppm)</label>
      <input id="curCYA" inputmode="decimal" placeholder="e.g., 45"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Calcium Hardness (ppm)</label>
      <input id="curCH" inputmode="decimal" placeholder="e.g., 120"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base placeholder:text-slate-400" />
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base mb-1.5">Targets</div>

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Free Chlorine target (ppm)</label>
      <input id="tFC" inputmode="decimal" value="6"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">pH target</label>
      <input id="tPH" inputmode="decimal" value="7.5"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Alkalinity target (ppm)</label>
      <input id="tALK" inputmode="decimal" value="90"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Cyanuric Acid target (ppm)</label>
      <input id="tCYA" inputmode="decimal" value="45"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

      <label class="block text-sm font-extrabold text-muted mt-3 mb-1">Calcium Hardness target (ppm)</label>
      <input id="tCH" inputmode="decimal" value="120"
        class="w-full rounded-xl border border-line bg-[#06181f] px-3 py-3 text-base" />

      <button class="w-full mt-3 bg-pindan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="runChem()">Calculate</button>

      <button class="w-full mt-2 bg-plan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="copyChemNotes(false)">Copy to notes</button>

      <button class="w-full mt-2 bg-teal rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="copyChemNotes(true)">Copy + add to handover</button>

      <div class="text-xs font-extrabold text-muted mt-2">Tip: “Copy + add to handover” appends the dosing block into the Handover message box.</div>
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base mb-1.5">Dose results</div>
      <div id="chemResults" class="text-xs font-extrabold text-muted">Enter values and press Calculate.</div>
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base mb-1.5">Safety reminders</div>
      <div class="text-xs font-extrabold text-muted leading-relaxed">
        • Follow facility SOP + SDS for handling/dosing.<br>
        • Add chemical to water where applicable (never water to chemical).<br>
        • Don’t exceed max dosing limits if your SOP has them.<br>
        • Record dosing where required.
      </div>
    </div>
  </div>

  <!-- CLOCK TAB -->
  <div id="tab-clock" class="px-3.5 pt-3.5 pb-5" style="display:none">
    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-[18px] mb-2">Clock in / out</div>
      <div class="text-xs font-extrabold text-muted">ZoomShift time clock</div>

      <button class="w-full mt-3 bg-pindan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="openClockSameTab()">Open Time Clock (same tab)</button>

      <button class="w-full mt-2 bg-plan rounded-2xl px-3 py-3 text-[17px] font-black text-white"
        type="button" onclick="openClockNewTab()">Open Time Clock (new tab)</button>

      <div class="text-xs font-extrabold text-muted mt-2">
        If the embedded view below stays blank, use the buttons above (ZoomShift may block embedding).
      </div>
    </div>

    <div class="bg-card border border-line rounded-2xl p-3.5 mb-3">
      <div class="font-black text-base mb-1.5">Embedded (if supported)</div>
      <div class="text-xs font-extrabold text-muted mb-2">Best for wall/iPad kiosk use, but depends on ZoomShift settings.</div>

      <div class="border border-line rounded-2xl overflow-hidden bg-[#06181f]">
        <iframe
          id="clockFrame"
          title="ZoomShift Time Clock"
          src="https://app.zoomshift.com/clm058b/time_clock"
          class="w-full h-[70vh] border-0"
          referrerpolicy="no-referrer-when-downgrade"
        ></iframe>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"
    class="fixed left-1/2 -translate-x-1/2 bottom-4 bg-[#05212a] border border-line px-4 py-3 rounded-2xl max-w-[92vw] font-black z-[999] hidden">
  </div>

<script>
window.addEventListener("error", (ev) => {
  const msg = ev && ev.message ? ev.message : "Unknown script error";
  toast("JS ERROR: " + msg, 6000);
});

// === LIVE DATA URLS ===
const PLANT_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=0&single=true&output=csv";

const NOTICE_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=684780974&single=true&output=csv";

const HANDOVER_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=871823190&single=true&output=csv";

// Your Apps Script web app endpoint (WRITE)
const WRITE_URL =
  "https://script.google.com/macros/s/AKfycbzAQ3ZDxtE-WHc-HxDIFbbDMPJMqyXf6K1qtt5pCaQBPPgA1gvLid8v7gvx9jnerBHJlg/exec";

let cached = [];
let selectedStatus = "";
let chemLast = null;

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

function toast(msg, ms=1800){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.remove("hidden");
  setTimeout(()=> t.classList.add("hidden"), ms);
}

/* ---- your JS below is unchanged ---- */
function parseCSV(text){ /* ... unchanged ... */ }
function rankStatus(s){ /* ... unchanged ... */ }
function isActiveNotice(startStr,endStr){ /* ... unchanged ... */ }
function audienceMatches(audienceCell,selected){ /* ... unchanged ... */ }
async function loadPlant(){ /* ... unchanged ... */ }
function wireStatusButtons(){ /* ... unchanged ... */ }
async function submitUpdate(){ /* ... unchanged ... */ }
function buildPlantSummary(){ /* ... unchanged ... */ }
async function loadNoticesForHandover(){ /* ... unchanged ... */ }
async function refreshHandover(){ /* ... unchanged ... */ }
async function setHandover(){ /* ... unchanged ... */ }
async function ackHandover(){ /* ... unchanged ... */ }
function switchTab(which){ /* ... unchanged ... */ }
function num(id){ /* ... unchanged ... */ }
function roundup(x,decimals){ /* ... unchanged ... */ }
function poolLitres(){ /* ... unchanged ... */ }
function pureKg(deltaPpm,volL){ /* ... unchanged ... */ }
function fmt(x,suffix){ /* ... unchanged ... */ }
function line(title,value){ /* ... unchanged ... */ }
function nowStamp(){ /* ... unchanged ... */ }
async function copyText(text){ /* ... unchanged ... */ }
function buildChemNotes(){ /* ... unchanged ... */ }
async function copyChemNotes(addToHandover=false){ /* ... unchanged ... */ }
function runChem(){ /* ... unchanged ... */ }

wireStatusButtons();
loadPlant().then(() => {
  const aud = document.getElementById("audience");
  if (aud) aud.addEventListener("change", refreshHandover);
}).catch(err => {
  console.error(err);
  toast("Could not load sheet data", 2500);
});

const ZOOMSHIFT_CLOCK_URL = "https://app.zoomshift.com/clm058b/time_clock";
function openClockSameTab(){ window.location.href = ZOOMSHIFT_CLOCK_URL; }
function openClockNewTab(){ window.open(ZOOMSHIFT_CLOCK_URL, "_blank", "noopener"); }
</script>
</body>
</html>
