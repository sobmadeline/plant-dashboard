<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><script src="https://cdn.tailwindcss.com"></script><link rel="stylesheet" href="./assets/app.css"/><script src="./assets/app.js"></script><title>Register</title></head><body class='bg-slate-50' onload='guard();loadAll();'>
<header class="bg-slate-900 text-white px-4 py-3 flex items-center justify-between gap-3 no-print">
  <div class="font-extrabold">Registers</div>
  <div class="flex items-center gap-3">
    <span id="whoami" class="text-white/90 text-sm font-semibold"></span>
    <button class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 font-bold" onclick="doLogout()">Logout</button>
  </div>
</header>
<div id="toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg z-50 no-print"></div>

<main class="max-w-6xl mx-auto p-4">
<div class="bg-white border rounded-2xl p-4 shadow-sm no-print">
  <div class="flex flex-wrap gap-3 items-end">
    <label class="block"><div class="text-xs font-bold">Month</div><input id="month" type="month" class="mt-1 border rounded-xl p-2"/></label>
    <label class="block"><div class="text-xs font-bold">Search</div><input id="q" class="mt-1 border rounded-xl p-2"/></label>
    <button class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold" onclick="loadAll()">Search</button>
    <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-extrabold" onclick="openPrint()">Print month</button>
  </div>
</div>
<div class="grid lg:grid-cols-2 gap-4 mt-4">
  <section class="bg-white border rounded-2xl p-4 shadow-sm"><div class="text-lg font-extrabold">Incidents</div><div id="incList" class="mt-3 space-y-2"></div></section>
  <section class="bg-white border rounded-2xl p-4 shadow-sm"><div class="text-lg font-extrabold">Refusals</div><div id="refList" class="mt-3 space-y-2"></div></section>
</div>
</main>
<script>
function incRow(i){return `<div class="border rounded-xl p-3 flex justify-between"><div><div class="font-extrabold">${i.incident_no}</div><div class="text-sm text-slate-600">${i.incident_date} ${String(i.incident_time||'').slice(0,5)} • ${i.location||''}</div></div><div class="flex gap-2"><a class="px-3 py-2 rounded-xl border font-bold" href="./view_incident.html?id=${i.id}">Open</a><a class="px-3 py-2 rounded-xl bg-slate-900 text-white font-bold" target="_blank" href="./print_incident.html?id=${i.id}">Print</a></div></div>`;}
function refRow(r){return `<div class="border rounded-xl p-3 flex justify-between"><div><div class="font-extrabold">${r.refusal_no}</div><div class="text-sm text-slate-600">${r.refusal_date} ${String(r.refusal_time||'').slice(0,5)} • ${r.location||''}</div></div><div class="flex gap-2"><a class="px-3 py-2 rounded-xl border font-bold" href="./view_refusal.html?id=${r.id}">Open</a><a class="px-3 py-2 rounded-xl bg-slate-900 text-white font-bold" target="_blank" href="./print_refusal.html?id=${r.id}">Print</a></div></div>`;}
async function loadAll(){
  try{
    const m=qs('#month').value||yyyymmToday();qs('#month').value=m;
    const q=qs('#q').value||'';
    const inc=await api(`./api/incidents_list.php?month=${encodeURIComponent(m)}&q=${encodeURIComponent(q)}`);
    const ref=await api(`./api/refusals_list.php?month=${encodeURIComponent(m)}&q=${encodeURIComponent(q)}`);
    qs('#incList').innerHTML=(inc.items||[]).map(incRow).join('')||'<div class="text-sm text-slate-500">No incidents.</div>';
    qs('#refList').innerHTML=(ref.items||[]).map(refRow).join('')||'<div class="text-sm text-slate-500">No refusals.</div>';
  }catch(e){toast(e.message);}
}
function openPrint(){const m=qs('#month').value||yyyymmToday();window.open(`./print_register.html?month=${encodeURIComponent(m)}`,'_blank');}
</script></body></html>
