<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Log Refusal of Service / Entry</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
<div id="toast" class="hidden fixed top-4 right-4 bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg z-50"></div>
<div class="max-w-6xl mx-auto p-4 md:p-8">
  <div class="flex items-center justify-between gap-3 mb-6">
    <div>
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Log Refusal of Service / Entry</h1>
      <p class="text-sm text-slate-600">BRAC Tools • Incident reporting and registers (WA)</p>
    </div>
    <div class="flex gap-2">
      <a class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-100" href="./incident_report.html">Log Incident</a>
      <a class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-100" href="./refusal_report.html">Log Refusal</a>
      <a class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-100" href="./incident_register.html">Registers</a>
      <a class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-100" href="./monthly_report.html">Monthly</a>
    </div>
  </div>

<div class="bg-white border rounded-2xl shadow-sm p-4 md:p-6">
  <div class="grid md:grid-cols-3 gap-4">
    <label class="block">
      <span class="text-sm font-semibold">Date</span>
      <input id="refusal_date" type="date" class="mt-1 w-full rounded-xl border p-2" />
    </label>
    <label class="block">
      <span class="text-sm font-semibold">Time</span>
      <input id="refusal_time" type="time" class="mt-1 w-full rounded-xl border p-2" />
    </label>
    <label class="block">
      <span class="text-sm font-semibold">Location</span>
      <input id="location" class="mt-1 w-full rounded-xl border p-2" placeholder="e.g. entry" />
    </label>
  </div>

  <div class="grid md:grid-cols-3 gap-4 mt-4">
    <label class="block">
      <span class="text-sm font-semibold">CCTV at location?</span>
      <select id="cctv_available" class="mt-1 w-full rounded-xl border p-2">
        <option value="">Unknown</option>
        <option value="1">Yes</option>
        <option value="0">No</option>
      </select>
    </label>
    <label class="block md:col-span-2">
      <span class="text-sm font-semibold">Reason for refusal</span>
      <select id="reason" class="mt-1 w-full rounded-xl border p-2">
        <option value="">Select…</option>
        <option>Drunkenness</option>
        <option>Juvenile / suspected juvenile - no acceptable proof of age</option>
        <option>Offensive / disorderly / quarrelsome behaviour</option>
        <option>Refused patron attempted to regain entry / offensive behaviour</option>
        <option>Banned Drinkers Register inoperable / not able to be used</option>
        <option>Other</option>
      </select>
    </label>
  </div>

  <div class="grid md:grid-cols-3 gap-4 mt-4">
    <label class="inline-flex items-center gap-2 bg-slate-50 border rounded-xl p-3">
      <input id="police_notified" type="checkbox" class="h-5 w-5">
      <span class="font-semibold">WA Police notified</span>
    </label>
    <label class="block md:col-span-2">
      <span class="text-sm font-semibold">Approved Manager on duty</span>
      <input id="approved_manager_name" class="mt-1 w-full rounded-xl border p-2" placeholder="Auto-fill from login if blank" />
    </label>
  </div>

  <div class="mt-5">
    <span class="text-sm font-semibold">Other comments</span>
    <textarea id="comments" rows="4" class="mt-1 w-full rounded-xl border p-2" placeholder="Details of refusal / notes."></textarea>
  </div>

  <div class="mt-6 bg-slate-50 border rounded-2xl p-4">
    <div class="flex items-center justify-between gap-3">
      <div class="font-extrabold">Link staff involved</div>
      <div class="flex gap-2 items-center">
        <input id="staff_search" class="rounded-xl border p-2" placeholder="Search staff…" />
        <button id="staff_go" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:opacity-90">Search</button>
      </div>
    </div>
    <div id="staff_results" class="mt-3 grid md:grid-cols-2 gap-2"></div>
    <div class="mt-4">
      <div class="font-semibold">Selected staff</div>
      <div id="staff_selected" class="mt-2 flex flex-wrap gap-2"></div>
    </div>
  </div>

  <div class="mt-6 flex items-center justify-end">
    <button id="submit" class="px-5 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:opacity-90">Submit Refusal</button>
  </div>
</div>

<script>
(function initDefaults(){
  const d = new Date();
  const pad = n=>String(n).padStart(2,'0');
  qs('#refusal_date').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  qs('#refusal_time').value = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
})();

let selectedStaff = new Map();
function renderSelected(){
  const wrap = qs('#staff_selected');
  wrap.innerHTML='';
  for (const [id,u] of selectedStaff.entries()){
    const el=document.createElement('button');
    el.className='px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-100';
    el.textContent=`${u.display_name} ✕`;
    el.onclick=()=>{selectedStaff.delete(id); renderSelected();};
    wrap.appendChild(el);
  }
}
async function staffSearch(){
  const q=qs('#staff_search').value.trim();
  const j=await api(`./api/users_list.php?q=${encodeURIComponent(q)}`);
  const out=qs('#staff_results'); out.innerHTML='';
  j.items.forEach(u=>{
    const b=document.createElement('button');
    b.className='text-left px-3 py-3 rounded-xl bg-white border hover:bg-slate-100';
    b.innerHTML=`<div class="font-bold">${u.display_name}</div><div class="text-xs text-slate-600">${u.role}</div>`;
    b.onclick=()=>{selectedStaff.set(String(u.id),u); renderSelected(); toast('Added');};
    out.appendChild(b);
  });
}
qs('#staff_go').onclick=()=>staffSearch();
qs('#staff_search').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){e.preventDefault(); staffSearch();}});

qs('#submit').onclick=async ()=>{
  try{
    const payload={
      refusal_date: qs('#refusal_date').value,
      refusal_time: qs('#refusal_time').value,
      location: qs('#location').value.trim(),
      cctv_available: qs('#cctv_available').value===''?null:Number(qs('#cctv_available').value),
      reason: qs('#reason').value,
      comments: qs('#comments').value,
      approved_manager_name: qs('#approved_manager_name').value.trim(),
      police_notified: qs('#police_notified').checked?1:0,
      staff_ids: [...selectedStaff.keys()].map(x=>Number(x)),
    };
    const j=await api('./api/refusals_create.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    toast(`Saved ${j.refusal_no}`);
    setTimeout(()=>location.href='./incident_register.html#tab=refusals',600);
  } catch(e){ toast(e.message); }
};
</script>

</div>

<script>
async function api(url, opts={}) {
  const res = await fetch(url, opts);
  const ct = res.headers.get('content-type') || '';
  if (!res.ok) {
    let msg = res.status + ' ' + res.statusText;
    try {
      if (ct.includes('application/json')) {
        const j = await res.json();
        msg = j.error || msg;
      } else msg = await res.text();
    } catch (e) {}
    throw new Error(msg);
  }
  if (ct.includes('application/json')) return await res.json();
  return await res.text();
}
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.remove('hidden');
  clearTimeout(window.__t_to);
  window.__t_to = setTimeout(()=>t.classList.add('hidden'), 2600);
}
function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return [...document.querySelectorAll(sel)]; }
</script>

</body>
</html>
