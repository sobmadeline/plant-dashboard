<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Incident & Refusal Registers</title>
<script src="https://cdn.tailwindcss.com"></script>

<script>
(async function guard(){
  try{
    const res = await fetch('/liquorincidents/api/whoami.php', { cache: 'no-store' });
    if (!res.ok) throw new Error('not logged in');
  } catch(e){
    const next = encodeURIComponent(location.pathname + location.search + location.hash);
    location.href = `/login.html?next=${next}`;
  }
})();
</script>

</head>
<body class="bg-slate-50 text-slate-900">
<div id="toast" class="hidden fixed top-4 right-4 bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg z-50"></div>
<div class="max-w-6xl mx-auto p-4 md:p-8">
  <div class="flex items-center justify-between gap-3 mb-6">
    <div>
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Incident & Refusal Registers</h1>
      <p class="text-sm text-slate-600">BRAC Tools • Incident reporting and registers (WA)</p>
    </div>
    <div class="flex gap-2">
      <a class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-100" href="./incident_report.html">Log Incident</a>
      <a class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-100" href="./refusal_report.html">Log Refusal</a>
      <a class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-100" href="./incident_register.html">Registers</a>
      <a class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-100" href="./monthly_report.html">Monthly</a>
    </div>
    <button id="logoutBtn"
      class="px-3 py-2 rounded-xl bg-slate-900 text-white font-bold hover:opacity-90">
      Logout
    </button>

    <script>
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      try {
        await fetch('/api/logout.php', { method: 'POST' });
      } catch {}
      location.href = '/login.html';
    });
    </script>
  </div>

<div class="bg-white border rounded-2xl shadow-sm p-4 md:p-6">
  <div class="flex flex-wrap gap-2 items-end justify-between">
    <div class="flex flex-wrap gap-2 items-end">
      <label class="block">
        <span class="text-xs font-semibold text-slate-700">From</span>
        <input id="from" type="date" class="mt-1 rounded-xl border p-2">
      </label>
      <label class="block">
        <span class="text-xs font-semibold text-slate-700">To</span>
        <input id="to" type="date" class="mt-1 rounded-xl border p-2">
      </label>
      <label class="block">
        <span class="text-xs font-semibold text-slate-700">Type</span>
        <input id="type" placeholder="exact type (optional)" class="mt-1 rounded-xl border p-2 w-72">
      </label>
      <label class="block">
        <span class="text-xs font-semibold text-slate-700">Police</span>
        <select id="police" class="mt-1 rounded-xl border p-2">
          <option value="">Any</option>
          <option value="1">Yes</option>
          <option value="0">No</option>
        </select>
      </label>
      <button id="go" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold hover:opacity-90">Filter</button>
    </div>

    <div class="flex gap-2">
      <button id="show_incidents" class="px-3 py-2 rounded-xl bg-emerald-600 text-white font-bold">Incidents</button>
      <button id="show_refusals" class="px-3 py-2 rounded-xl bg-white border font-bold">Refusals</button>
    </div>
  </div>

  <div id="list" class="mt-4 overflow-auto border rounded-2xl"></div>
</div>

<div id="drawer" class="hidden fixed inset-0 bg-black/30 z-40">
  <div class="absolute right-0 top-0 h-full w-full md:w-[680px] bg-white shadow-xl p-4 md:p-6 overflow-auto">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div id="d_title" class="text-xl font-extrabold"></div>
        <div id="d_meta" class="text-sm text-slate-600"></div>
      </div>
      <button id="d_close" class="px-3 py-2 rounded-xl border hover:bg-slate-100">Close</button>
    </div>

    <div id="d_warn" class="mt-4 hidden bg-amber-50 border border-amber-200 rounded-2xl p-3">
      <div class="font-extrabold text-amber-900">Soft lock: editing is allowed but fully audited</div>
      <div class="text-sm text-amber-900">You must enter an edit reason. A before/after snapshot + diff will be saved.</div>
    </div>

    <div class="mt-4 grid gap-3">
      <div class="grid md:grid-cols-2 gap-3">
        <label class="block">
          <span class="text-xs font-semibold text-slate-700">Date</span>
          <input id="e_date" type="date" class="mt-1 w-full rounded-xl border p-2">
        </label>
        <label class="block">
          <span class="text-xs font-semibold text-slate-700">Time</span>
          <input id="e_time" type="time" class="mt-1 w-full rounded-xl border p-2">
        </label>
      </div>

      <label class="block">
        <span class="text-xs font-semibold text-slate-700">Location</span>
        <input id="e_location" class="mt-1 w-full rounded-xl border p-2">
      </label>

      <div class="grid md:grid-cols-2 gap-3">
        <label class="block">
          <span class="text-xs font-semibold text-slate-700">CCTV</span>
          <select id="e_cctv" class="mt-1 w-full rounded-xl border p-2">
            <option value="">Unknown</option>
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </label>
        <label class="inline-flex items-center gap-2 mt-6 bg-slate-50 border rounded-xl p-3">
          <input id="e_police" type="checkbox" class="h-5 w-5">
          <span class="font-bold">Police notified</span>
        </label>
      </div>

      <label class="block">
        <span class="text-xs font-semibold text-slate-700">Incident type</span>
        <input id="e_type" class="mt-1 w-full rounded-xl border p-2">
      </label>

      <label class="inline-flex items-center gap-2 bg-slate-50 border rounded-xl p-3">
        <input id="e_force" type="checkbox" class="h-5 w-5">
        <span class="font-bold">Physical force used</span>
      </label>

      <label class="block">
        <span class="text-xs font-semibold text-slate-700">Details</span>
        <textarea id="e_details" rows="5" class="mt-1 w-full rounded-xl border p-2"></textarea>
      </label>

      <label class="block">
        <span class="text-xs font-semibold text-slate-700">Actions taken</span>
        <textarea id="e_actions" rows="4" class="mt-1 w-full rounded-xl border p-2"></textarea>
      </label>

      <label class="block">
        <span class="text-xs font-semibold text-slate-700">Edit reason (required)</span>
        <input id="e_reason" class="mt-1 w-full rounded-xl border p-2" placeholder="Why are you editing this record?">
      </label>

      <div class="flex items-center justify-between gap-3">
        <button id="btn_police_one" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:opacity-90">One‑click Police Flag</button>
        <button id="btn_save" class="px-5 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:opacity-90">Save Edit</button>
      </div>

      <div class="mt-4 border rounded-2xl p-4">
        <div class="font-extrabold">Photo / PDF attachments</div>
        <div class="text-sm text-slate-600">Allowed: JPG/PNG/WebP/PDF • Max size configured in app/config.php</div>
        <div class="mt-3 flex gap-2 items-center">
          <input id="file" type="file" class="block w-full text-sm" />
          <button id="btn_upload" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold hover:opacity-90">Upload</button>
        </div>
        <div id="files" class="mt-3 grid gap-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
let mode = 'incidents';
let currentIncidentId = null;

function setTab(which){
  mode = which;
  qs('#show_incidents').className = which==='incidents'
    ? 'px-3 py-2 rounded-xl bg-emerald-600 text-white font-bold'
    : 'px-3 py-2 rounded-xl bg-white border font-bold';
  qs('#show_refusals').className = which==='refusals'
    ? 'px-3 py-2 rounded-xl bg-emerald-600 text-white font-bold'
    : 'px-3 py-2 rounded-xl bg-white border font-bold';
  load();
}

qs('#show_incidents').onclick = ()=>setTab('incidents');
qs('#show_refusals').onclick = ()=>setTab('refusals');
qs('#go').onclick = ()=>load();

function table(headers, rows){
  const th = headers.map(h=>`<th class="text-left text-xs font-extrabold p-3 bg-slate-50 border-b">${h}</th>`).join('');
  const trs = rows.join('');
  return `<table class="min-w-full text-sm"><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
}

async function load(){
  try{
    const from = qs('#from').value, to = qs('#to').value, type = qs('#type').value.trim(), police = qs('#police').value;
    if (mode === 'incidents'){
      const q = new URLSearchParams();
      if(from) q.set('from', from);
      if(to) q.set('to', to);
      if(type) q.set('type', type);
      if(police!=='') q.set('police', police);
      const j = await api(`./api/incidents_get.php?${q.toString()}`);
      const rows = j.items.map(it=>`
        <tr class="hover:bg-slate-50 cursor-pointer" data-id="${it.id}">
          <td class="p-3 border-b font-bold">${it.incident_no}</td>
          <td class="p-3 border-b">${it.incident_date} ${it.incident_time}</td>
          <td class="p-3 border-b">${it.location||''}</td>
          <td class="p-3 border-b">${it.incident_type}</td>
          <td class="p-3 border-b">${it.police_notified==1?'Yes':'No'}</td>
        </tr>
      `);
      qs('#list').innerHTML = table(['Incident #','When','Location','Type','Police'], rows);
      qsa('#list tr[data-id]').forEach(tr=>tr.onclick=()=>openIncident(tr.dataset.id));
    } else {
      const q = new URLSearchParams();
      if(from) q.set('from', from);
      if(to) q.set('to', to);
      if(police!=='') q.set('police', police);
      const j = await api(`./api/refusals_get.php?${q.toString()}`);
      const rows = j.items.map(it=>`
        <tr class="hover:bg-slate-50">
          <td class="p-3 border-b font-bold">${it.refusal_no}</td>
          <td class="p-3 border-b">${it.refusal_date} ${it.refusal_time}</td>
          <td class="p-3 border-b">${it.location||''}</td>
          <td class="p-3 border-b">${it.reason}</td>
          <td class="p-3 border-b">${it.police_notified==1?'Yes':'No'}</td>
        </tr>
      `);
      qs('#list').innerHTML = table(['Refusal #','When','Location','Reason','Police'], rows);
    }

    // hash routing
    const hash = location.hash || '';
    if (hash.startsWith('#incident=')) {
      const id = hash.split('=')[1];
      if (id) openIncident(id);
    }
    if (hash.includes('tab=refusals')) setTab('refusals');
  } catch(e){
    toast(e.message);
  }
}

async function openIncident(id){
  try{
    const j = await api(`./api/incidents_get.php?id=${id}`);
    const it = j.incident;
    currentIncidentId = it.id;
    qs('#d_title').textContent = `${it.incident_no}`;
    qs('#d_meta').textContent = `${it.incident_date} ${it.incident_time} • ${it.location||''}`;

    qs('#d_warn').classList.remove('hidden');

    qs('#e_date').value = it.incident_date;
    qs('#e_time').value = it.incident_time.substring(0,5);
    qs('#e_location').value = it.location||'';
    qs('#e_cctv').value = (it.cctv_available===null||it.cctv_available===undefined) ? '' : String(it.cctv_available);
    qs('#e_police').checked = it.police_notified==1;
    qs('#e_type').value = it.incident_type;
    qs('#e_force').checked = it.physical_force==1;
    qs('#e_details').value = it.incident_details||'';
    qs('#e_actions').value = it.actions_taken||'';
    qs('#e_reason').value = '';

    renderFiles(it.files||[]);
    qs('#drawer').classList.remove('hidden');
  } catch(e){ toast(e.message); }
}

function renderFiles(files){
  const wrap = qs('#files');
  wrap.innerHTML = '';
  if (!files.length){
    wrap.innerHTML = '<div class="text-sm text-slate-600">No files attached.</div>';
    return;
  }
  files.forEach(f=>{
    const a = document.createElement('a');
    a.className = 'px-3 py-2 rounded-xl border bg-white hover:bg-slate-100 flex items-center justify-between gap-3';
    a.href = `./api/files_download.php?id=${f.id}`;
    a.innerHTML = `<span class="font-bold">${f.original_name}</span><span class="text-xs text-slate-600">${Math.round(f.file_size/1024)} KB</span>`;
    wrap.appendChild(a);
  });
}

qs('#d_close').onclick = ()=>{ qs('#drawer').classList.add('hidden'); location.hash=''; };

qs('#btn_police_one').onclick = async ()=>{
  try{
    if (!currentIncidentId) return;
    await api('./api/incidents_police_flag.php', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id: Number(currentIncidentId), police_notified: 1})});
    qs('#e_police').checked = true;
    toast('Police flag set');
  } catch(e){ toast(e.message); }
};

qs('#btn_save').onclick = async ()=>{
  try{
    if (!currentIncidentId) return;
    const reason = qs('#e_reason').value.trim();
    if (!reason) { toast('Edit reason is required'); return; }
    const payload = {
      id: Number(currentIncidentId),
      incident_date: qs('#e_date').value,
      incident_time: qs('#e_time').value,
      location: qs('#e_location').value.trim(),
      cctv_available: qs('#e_cctv').value===''?null:Number(qs('#e_cctv').value),
      police_notified: qs('#e_police').checked ? 1 : 0,
      incident_type: qs('#e_type').value.trim(),
      physical_force: qs('#e_force').checked ? 1 : 0,
      incident_details: qs('#e_details').value,
      actions_taken: qs('#e_actions').value,
      edit_reason: reason,
    };
    const j = await api('./api/incidents_edit.php', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if (j.no_change) toast('No changes');
    else toast('Saved + audited');
    load();
  } catch(e){ toast(e.message); }
};

qs('#btn_upload').onclick = async ()=>{
  try{
    if (!currentIncidentId) return;
    const file = qs('#file').files[0];
    if (!file) { toast('Choose a file'); return; }
    const fd = new FormData();
    fd.append('incident_id', String(currentIncidentId));
    fd.append('file', file);
    const j = await api('./api/incidents_upload.php', {method:'POST', body: fd});
    toast('Uploaded');
    // refresh details
    const d = await api(`./api/incidents_get.php?id=${currentIncidentId}`);
    renderFiles(d.incident.files||[]);
  } catch(e){ toast(e.message); }
};

load();
</script>

</div>

<script>
async function api(url, opts={}) {
  const res = await fetch(url, opts);
  const ct = res.headers.get('content-type') || '';
  if (!res.ok) {
    let msg = res.status + ' ' + res.statusText;
    try {
      if (ct.includes('application/json')) {
        const j = await res.json();
        msg = j.error || msg;
      } else msg = await res.text();
    } catch (e) {}
    throw new Error(msg);
  }
  if (ct.includes('application/json')) return await res.json();
  return await res.text();
}
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.remove('hidden');
  clearTimeout(window.__t_to);
  window.__t_to = setTimeout(()=>t.classList.add('hidden'), 2600);
}
function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return [...document.querySelectorAll(sel)]; }
</script>

</body>
</html>
