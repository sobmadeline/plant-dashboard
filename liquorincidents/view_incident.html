<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><script src="https://cdn.tailwindcss.com"></script><link rel="stylesheet" href="./assets/app.css"/><script src="./assets/app.js"></script><title>Incident</title></head><body class='bg-slate-50' onload='guard();load();'>
<header class="bg-slate-900 text-white px-4 py-3 flex items-center justify-between gap-3 no-print">
  <div class="font-extrabold">Incident</div>
  <div class="flex items-center gap-3">
    <span id="whoami" class="text-white/90 text-sm font-semibold"></span>
    <button class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 font-bold" onclick="doLogout()">Logout</button>
  </div>
</header>
<div id="toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg z-50 no-print"></div>

<main class="max-w-4xl mx-auto p-4">
<div id="warn" class="hidden bg-amber-50 border border-amber-200 text-amber-900 p-3 rounded-2xl mb-3"></div>
<div class="bg-white border rounded-2xl p-5 shadow-sm">
  <div id="top"></div>
  <div class="grid md:grid-cols-2 gap-4 mt-4">
    <label class="block"><div class="text-xs font-bold">Date</div><input id="incident_date" type="date" class="mt-1 w-full border rounded-xl p-2"></label>
    <label class="block"><div class="text-xs font-bold">Time</div><input id="incident_time" type="time" class="mt-1 w-full border rounded-xl p-2"></label>
    <label class="block md:col-span-2"><div class="text-xs font-bold">Location</div><input id="location" class="mt-1 w-full border rounded-xl p-2"></label>
    <label class="block"><div class="text-xs font-bold">Type</div><input id="incident_type" class="mt-1 w-full border rounded-xl p-2"></label>
    <label class="block"><div class="text-xs font-bold">CCTV</div><select id="cctv_available" class="mt-1 w-full border rounded-xl p-2"><option value="">Unknown</option><option value="1">Yes</option><option value="0">No</option></select></label>
    <label class="block"><div class="text-xs font-bold">Approved manager</div><input id="approved_manager_name" class="mt-1 w-full border rounded-xl p-2"></label>
    <label class="block"><div class="text-xs font-bold">Reporting person</div><input id="reporting_person_name" class="mt-1 w-full border rounded-xl p-2"></label>
    <label class="block md:col-span-2"><div class="text-xs font-bold">Authorities (comma)</div><input id="authorities_notified" class="mt-1 w-full border rounded-xl p-2"></label>
    <div class="md:col-span-2 flex gap-6">
      <label class="flex items-center gap-2"><input id="police_notified" type="checkbox">Police notified</label>
      <label class="flex items-center gap-2"><input id="physical_force" type="checkbox">Physical force</label>
    </div>
    <label class="block md:col-span-2"><div class="text-xs font-bold">Details</div><textarea id="incident_details" rows="5" class="mt-1 w-full border rounded-xl p-2"></textarea></label>
    <label class="block md:col-span-2"><div class="text-xs font-bold">Actions</div><textarea id="actions_taken" rows="4" class="mt-1 w-full border rounded-xl p-2"></textarea></label>
  </div>

  <div class="mt-4 border-t pt-4">
    <div class="font-extrabold">Attachments</div>
    <div id="files" class="text-sm mt-2 space-y-1"></div>
    <div class="mt-2 flex gap-2 items-center no-print">
      <input id="file" type="file" class="text-sm"/>
      <button class="px-3 py-2 rounded-xl bg-slate-900 text-white font-bold" onclick="upload()">Upload</button>
    </div>
  </div>

  <div class="mt-4 flex flex-wrap gap-2 justify-end no-print">
    <a class="px-4 py-2 rounded-xl border font-bold" href="./register.html">Back</a>
    <a class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold" target="_blank" id="printLink">Print</a>
    <input id="edit_reason" class="px-3 py-2 rounded-xl border" placeholder="Edit reason (required)"/>
    <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-extrabold" onclick="save()">Save changes</button>
  </div>
</div></main>
<script>
let ID=null;
function renderFiles(files){
  qs('#files').innerHTML = (files||[]).map(f=>{
    const href=`./api/file_download.php?entity=incident&id=${f.id}`;
    return `<div><a class="underline" href="${href}" target="_blank">${f.original_name}</a></div>`;
  }).join('') || '<div class="text-slate-500">No attachments.</div>';
}
async function load(){
  const u=new URL(location.href);ID=u.searchParams.get('id');qs('#printLink').href='./print_incident.html?id='+encodeURIComponent(ID);
  const lock=await api('./api/lock_acquire.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({entity_type:'incident',entity_id:Number(ID),ttl_min:15})});
  if(lock.warning){qs('#warn').classList.remove('hidden');qs('#warn').textContent=`Heads up: someone else may be editing this record (staff ID ${lock.lock.locked_by_staff_id}).`;}
  const out=await api('./api/incidents_get.php?id='+encodeURIComponent(ID));const i=out.item;
  qs('#top').innerHTML=`<div class="text-2xl font-extrabold">${i.incident_no}</div><div class="text-sm text-slate-600">Created by ${i.created_by_name||''}</div>`;
  qs('#incident_date').value=i.incident_date||'';qs('#incident_time').value=String(i.incident_time||'').slice(0,5);
  qs('#location').value=i.location||'';qs('#incident_type').value=i.incident_type||'';
  qs('#cctv_available').value=(i.cctv_available===null||i.cctv_available===undefined)?'':String(i.cctv_available);
  qs('#approved_manager_name').value=i.approved_manager_name||'';qs('#reporting_person_name').value=i.reporting_person_name||'';
  const auths=i.authorities_notified_json?JSON.parse(i.authorities_notified_json):[];qs('#authorities_notified').value=(auths||[]).join(', ');
  qs('#police_notified').checked=Number(i.police_notified)===1;qs('#physical_force').checked=Number(i.physical_force)===1;
  qs('#incident_details').value=i.incident_details||'';qs('#actions_taken').value=i.actions_taken||'';
  renderFiles(out.files||[]);
}
async function upload(){
  try{
    const inp=qs('#file'); if(!inp.files||!inp.files[0]) return toast('Choose a file first');
    const fd=new FormData(); fd.append('incident_id',ID); fd.append('file',inp.files[0]);
    await api('./api/incident_upload.php',{method:'POST',body:fd}); toast('Uploaded'); inp.value='';
    const out=await api('./api/incidents_get.php?id='+encodeURIComponent(ID)); renderFiles(out.files||[]);
  }catch(e){toast(e.message);}
}
async function save(){
  try{
    const reason=qs('#edit_reason').value.trim(); if(!reason) return toast('Edit reason required');
    const auths=(qs('#authorities_notified').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    await api('./api/incidents_update.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      id:Number(ID),edit_reason:reason,incident_date:qs('#incident_date').value,incident_time:qs('#incident_time').value,location:qs('#location').value,
      cctv_available:qs('#cctv_available').value===''?null:Number(qs('#cctv_available').value),
      approved_manager_name:qs('#approved_manager_name').value,reporting_person_name:qs('#reporting_person_name').value,incident_type:qs('#incident_type').value,
      authorities_notified:auths,police_notified:qs('#police_notified').checked?1:0,physical_force:qs('#physical_force').checked?1:0,
      incident_details:qs('#incident_details').value,actions_taken:qs('#actions_taken').value
    })});
    toast('Saved'); qs('#edit_reason').value='';
  }catch(e){toast(e.message);}
}
window.addEventListener('beforeunload',()=>{ if(!ID) return; navigator.sendBeacon('./api/lock_release.php', new Blob([JSON.stringify({entity_type:'incident',entity_id:Number(ID)})],{type:'application/json'})); });
</script></body></html>
