<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><script src="https://cdn.tailwindcss.com"></script><link rel="stylesheet" href="./assets/app.css"/><script src="./assets/app.js"></script>
<title>Permissions</title></head>
<body class="bg-slate-50" onload="guard(); loadPerms();">

<header class="bg-slate-900 text-white px-4 py-3 flex items-center justify-between gap-3 no-print">
  <div class="font-extrabold">Permissions</div>
  <div class="flex items-center gap-3">
    <span id="whoami" class="text-white/90 text-sm font-semibold"></span>
    <button class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 font-bold" onclick="doLogout()">Logout</button>
  </div>
</header>
<div id="toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg z-50 no-print"></div>

<main class="max-w-6xl mx-auto p-4">
  <div class="bg-white border rounded-2xl p-4 shadow-sm">
    <div class="text-sm text-slate-600">Role defaults (audited). Per-user overrides + sync will be the next add-on.</div>
    <div id="grid" class="mt-4 overflow-auto"></div>
  </div>
</main>

<script>
async function loadPerms(){
  try{
    const snap = await api('./api/permissions_snapshot.php');
    const roles = snap.roles || [];
    const perms = snap.permissions || [];
    const rp = snap.role_permissions || [];
    const map = new Map(rp.map(x=>[`${x.role_key}::${x.perm_key}`, Number(x.allowed)]));

    let html = `<table class="min-w-[900px] w-full text-sm border-collapse">
      <thead><tr><th class="border p-2 text-left">Permission</th>`;
    roles.forEach(r=>{ html += `<th class="border p-2">${r.role_key}</th>`; });
    html += `</tr></thead><tbody>`;

    perms.forEach(p=>{
      html += `<tr><td class="border p-2"><div class="font-bold">${p.perm_key}</div><div class="text-xs text-slate-500">${p.label}</div></td>`;
      roles.forEach(r=>{
        const k = `${r.role_key}::${p.perm_key}`;
        const v = map.get(k) || 0;
        html += `<td class="border p-2 text-center">
          <input type="checkbox" data-role="${r.role_key}" data-perm="${p.perm_key}" ${v? 'checked':''} />
        </td>`;
      });
      html += `</tr>`;
    });

    html += `</tbody></table>`;
    qs('#grid').innerHTML = html;

    qsa('#grid input[type=checkbox]').forEach(cb=>{
      cb.addEventListener('change', async (e)=>{
        const role_key = e.target.getAttribute('data-role');
        const perm_key = e.target.getAttribute('data-perm');
        const allowed = e.target.checked ? 1 : 0;
        try{
          await api('./api/role_permissions_set.php', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({role_key, perm_key, allowed})});
          toast('Saved');
        } catch(err){
          toast(err.message);
          e.target.checked = !e.target.checked;
        }
      });
    });
  } catch(e){
    toast(e.message);
  }
}
</script>
</body></html>
