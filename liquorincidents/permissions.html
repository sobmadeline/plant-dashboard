<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><script src="https://cdn.tailwindcss.com"></script><link rel="stylesheet" href="./assets/app.css"/><script src="./assets/app.js"></script><title>Permissions</title></head><body class='bg-slate-50' onload='guard();init();'>
<header class="bg-slate-900 text-white px-4 py-3 flex items-center justify-between gap-3 no-print">
  <div class="font-extrabold">Permissions</div>
  <div class="flex items-center gap-3">
    <span id="whoami" class="text-white/90 text-sm font-semibold"></span>
    <button class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 font-bold" onclick="doLogout()">Logout</button>
  </div>
</header>
<div id="toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-3 rounded-xl shadow-lg z-50 no-print"></div>

<main class="max-w-6xl mx-auto p-4"><div class="bg-white border rounded-2xl p-4 shadow-sm">
<div class="flex gap-3 items-center">
  <button id="tabRole" class="px-3 py-2 rounded-xl bg-slate-900 text-white font-bold">Role matrix</button>
  <button id="tabUser" class="px-3 py-2 rounded-xl border font-bold">User overrides</button>
</div>
<div id="rolePane" class="mt-4"><div id="grid" class="overflow-auto"></div></div>
<div id="userPane" class="mt-4 hidden">
  <div class="flex flex-wrap gap-3 items-end">
    <label class="block"><div class="text-xs font-bold">Staff</div><select id="staffPick" class="mt-1 border rounded-xl p-2 min-w-[280px]"></select></label>
    <button class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold" onclick="loadOverrides()">Load</button>
    <button class="px-4 py-2 rounded-xl border font-bold" onclick="resetOverrides()">Reset overrides</button>
  </div>
  <div id="ovGrid" class="mt-4 overflow-auto"></div>
</div></div></main>
<script>
let SNAP=null;
function showTab(which){
  qs('#rolePane').classList.toggle('hidden', which!=='role');
  qs('#userPane').classList.toggle('hidden', which!=='user');
  qs('#tabRole').classList.toggle('bg-slate-900', which==='role');
  qs('#tabRole').classList.toggle('text-white', which==='role');
  qs('#tabUser').classList.toggle('bg-slate-900', which==='user');
  qs('#tabUser').classList.toggle('text-white', which==='user');
  qs('#tabRole').classList.toggle('border', which==='user');
  qs('#tabUser').classList.toggle('border', which==='role');
}
async function init(){
  qs('#tabRole').onclick=()=>showTab('role');
  qs('#tabUser').onclick=()=>showTab('user');
  await loadRoleMatrix(); await loadStaffPick();
}
async function loadRoleMatrix(){
  SNAP=await api('./api/permissions_snapshot.php');
  const roles=SNAP.roles||[], perms=SNAP.permissions||[], rp=SNAP.role_permissions||[];
  const map=new Map(rp.map(x=>[`${x.role_key}::${x.perm_key}`, Number(x.allowed)]));
  let html=`<table class="min-w-[900px] w-full text-sm border-collapse"><thead><tr><th class="border p-2 text-left">Permission</th>`;
  roles.forEach(r=>{html+=`<th class="border p-2">${r.role_key}</th>`;}); html+=`</tr></thead><tbody>`;
  perms.forEach(p=>{
    html+=`<tr><td class="border p-2"><div class="font-bold">${p.perm_key}</div><div class="text-xs text-slate-500">${p.label}</div></td>`;
    roles.forEach(r=>{
      const v=map.get(`${r.role_key}::${p.perm_key}`)||0;
      html+=`<td class="border p-2 text-center"><input type="checkbox" data-role="${r.role_key}" data-perm="${p.perm_key}" ${v?'checked':''}></td>`;
    });
    html+=`</tr>`;
  });
  html+=`</tbody></table>`;
  qs('#grid').innerHTML=html;
  qsa('#grid input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', async (e)=>{
      const role_key=e.target.getAttribute('data-role');
      const perm_key=e.target.getAttribute('data-perm');
      const allowed=e.target.checked?1:0;
      try{ await api('./api/role_permissions_set.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role_key,perm_key,allowed})}); toast('Saved'); }
      catch(err){ toast(err.message); e.target.checked=!e.target.checked; }
    });
  });
}
async function loadStaffPick(){
  const staff=await api('./api/staff_list.php');
  qs('#staffPick').innerHTML=(staff.items||[]).map(s=>`<option value="${s.id}">${s.name} (${s.role})</option>`).join('');
}
async function loadOverrides(){
  const staff_id=Number(qs('#staffPick').value);
  const ov=await api(`./api/user_overrides_get.php?staff_id=${encodeURIComponent(staff_id)}`);
  const overrides=new Map((ov.items||[]).map(x=>[x.perm_key,x]));
  const perms=SNAP.permissions||[];
  let html=`<table class="min-w-[900px] w-full text-sm border-collapse"><thead><tr><th class="border p-2 text-left">Permission</th><th class="border p-2">Override</th><th class="border p-2 text-left">Reason</th><th class="border p-2">Action</th></tr></thead><tbody>`;
  perms.forEach(p=>{
    const o=overrides.get(p.perm_key); const effect=o?o.effect:''; const reason=o?(o.reason||''):'';
    html+=`<tr><td class="border p-2"><div class="font-bold">${p.perm_key}</div><div class="text-xs text-slate-500">${p.label}</div></td>
      <td class="border p-2 text-center"><select data-perm="${p.perm_key}" class="border rounded-lg p-1">
        <option value="" ${effect===''?'selected':''}>â€”</option><option value="allow" ${effect==='allow'?'selected':''}>allow</option><option value="deny" ${effect==='deny'?'selected':''}>deny</option></select></td>
      <td class="border p-2"><input data-reason="${p.perm_key}" class="w-full border rounded-lg p-1" value="${reason.replaceAll('"','&quot;')}"></td>
      <td class="border p-2 text-center"><button class="px-3 py-1 rounded-lg bg-slate-900 text-white font-bold" onclick="saveOverride('${p.perm_key}')">Save</button>
        <button class="px-3 py-1 rounded-lg border font-bold" onclick="deleteOverride('${p.perm_key}')">Clear</button></td></tr>`;
  });
  html+=`</tbody></table>`;
  qs('#ovGrid').innerHTML=html;
}
async function saveOverride(perm){
  try{
    const staff_id=Number(qs('#staffPick').value);
    const effect=qs(`select[data-perm="${perm}"]`).value;
    const reason=qs(`input[data-reason="${perm}"]`).value||'';
    if(!effect) return toast('Pick allow/deny first (or Clear)');
    await api('./api/user_override_set.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({staff_id,perm_key:perm,effect,reason})});
    toast('Saved');
  }catch(e){toast(e.message);}
}
async function deleteOverride(perm){
  try{
    const staff_id=Number(qs('#staffPick').value);
    const reason=qs(`input[data-reason="${perm}"]`).value||'';
    await api('./api/user_override_set.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({staff_id,perm_key:perm,effect:'delete',reason})});
    toast('Cleared'); await loadOverrides();
  }catch(e){toast(e.message);}
}
async function resetOverrides(){
  try{
    const staff_id=Number(qs('#staffPick').value);
    const out=await api('./api/user_overrides_reset.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({staff_ids:[staff_id]})});
    toast('Reset ('+out.deleted+' removed)'); await loadOverrides();
  }catch(e){toast(e.message);}
}
</script></body></html>
