<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="./images/favicon.ico">
  <title>Aquatic Bookings - BRAC Tools</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pindan: "#C54B00",
            darkturq: "#004153",
            bg: "#07141a",
            card: "#0b2028",
            line: "#14313b",
            muted: "#cbd5e1",
            good: "#15803d",
            warn: "#ca8a04",
            bad: "#b91c1c",
            plan: "#2563eb",
            teal: "#0f766e"
          }
        }
      }
    }
  </script>

  <style>
    /* Prevent cards splitting across CSS columns */
    .no-break {
      break-inside: avoid;
      page-break-inside: avoid;
      -webkit-column-break-inside: avoid;

      /* Important for multi-column layouts */
      display: inline-block;
      width: 100%;
    }
    .booking-row{ margin-bottom: 0.75rem; }

    /* Booking status styling */
    .bookingRow.is-past { opacity: 0.38; filter: grayscale(35%); }
    .bookingRow.is-ongoing { border-color: #22c55e !important; } /* green outline */
    .status-pill {
      border-radius: 9999px;
      padding: 2px 10px;
      font-size: 11px;
      font-weight: 900;
      line-height: 1.2;
      display: inline-block;
    }
    .status-pill.now { background: #16a34a; color: #ffffff; }
    .status-pill.soon { background: #f59e0b; color: #0b1220; }
    .status-pill.done { background: #334155; color: #ffffff; }
</style>
</head>

<body class="m-0 font-sans bg-bg text-slate-50 text-[15px] min-h-screen overflow-y-auto">
  <!-- Header -->
  <header class="bg-darkturq px-2 py-3.5 md:flex items-center justify-between gap-4">
    <!-- Left: logo + titles -->
    <div class="flex items-center gap-3 min-w-0">
      <a href="index.html" class="max-h-10 max-w-[211px] rounded-xl text-white flex items-center justify-center font-black tracking-wide">
        <img src="./images/WhiteWebsiteLogo.png" alt="BRAC Logo" class="object-contain" />
      </a>

      <div class="min-w-0">
        <div class="text-[18px] font-black leading-tight truncate">Aquatic Bookings</div>
        <div class="text-[13px] opacity-85 mt-0.5 truncate">Broome Recreation & Aquatic Centre</div>
        <div class="text-[12px] font-extrabold text-muted mt-0.5 truncate" id="sourceInfo">—</div>
      </div>
    </div>

    <!-- Right: controls -->
    <div class="flex items-center gap-2 shrink-0 md:mt-0 mt-4">
      <input
        id="datePick"
        type="date"
        class="rounded-xl border border-line bg-[#06181f] px-3 py-2 text-sm font-extrabold"
        onchange="render()"
      />
      <button
        class="rounded-2xl px-3 py-2 font-black text-white bg-plan"
        type="button"
        onclick="loadAll(true)"
      >Refresh</button>
    </div>
  </header>

  <!-- Main -->
  <div class="px-3.5 pt-3.5 pb-5">
    <!--
      CSS columns:
      - column-gap is NOT controlled by Tailwind's gap-* utilities, so we set it explicitly.
      - height is set to fill the viewport minus header+padding; tune the 140px number if needed.
    -->
    <div
      id="venueWrap" class="max-w-[1920px] mx-auto"
    ></div>
  </div>

  <!-- Toast -->
  <div
    id="toast"
    style="display:none"
    class="fixed bottom-3 left-1/2 -translate-x-1/2 bg-[#06181f] border border-line rounded-2xl px-4 py-2 text-sm font-black shadow"
  ></div>

  <script>
    // ====== CONFIG ======
    const WRITE_URL = "https://script.google.com/macros/s/AKfycbzygxLa5-VSIkWuFe1jWt930bK0kMhrn0QKR8aAKFuF5wSaRagoATKWMfESgQu6OkizHQ/exec";
    const VENUES = ["Swimming Pool"];

    // ====== STATE ======
    let manualBookings = [];
    let pmBookings = [];
    let lastPerfectMindFile = "";

    // ====== UI HELPERS ======
    function toast(msg, ms = 1800) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => (t.style.display = "none"), ms);
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[c]));
    }

    function normalizeDate(s){
      // Normalise to ISO YYYY-MM-DD so we can compare dates reliably
      const str = String(s ?? "").trim();
      if (!str) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;

      // dd/mm/yyyy or d/m/yyyy (AU style)
      let m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(str);
      if (m){
        const dd = m[1].padStart(2,"0");
        const mm = m[2].padStart(2,"0");
        const yyyy = m[3];
        return `${yyyy}-${mm}-${dd}`;
      }

      // dd-mm-yyyy
      m = /^(\d{1,2})-(\d{1,2})-(\d{4})$/.exec(str);
      if (m){
        const dd = m[1].padStart(2,"0");
        const mm = m[2].padStart(2,"0");
        const yyyy = m[3];
        return `${yyyy}-${mm}-${dd}`;
      }

      return str;
    }

    function toMin(t) {
      // HH:MM -> minutes
      const m = /^(\d{1,2}):(\d{2})$/.exec(String(t || "").trim());
      if (!m) return 999999;
      return (parseInt(m[1], 10) * 60) + parseInt(m[2], 10);
    }

    function getSelectedDate() {
      return document.getElementById("datePick").value;
    }

    // ====== NETWORK ======
    async function getJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      return await res.json();
    }

    async function loadManual() {
      const data = await getJSON(`${WRITE_URL}?action=getBookings`);
      if (!data.ok) throw new Error(data.error || "Manual bookings failed");
      manualBookings = data.items || [];
    }

    async function loadPerfectMind() {
      const data = await getJSON(`${WRITE_URL}?action=getPerfectMind`);
      if (!data.ok) throw new Error(data.error || "PerfectMind failed");
      pmBookings = data.items || [];
      lastPerfectMindFile = data.fileName ? `${data.fileName}` : "";
      return data;
    }

    async function deleteManual(rowNumber) {
      if (!confirm(`Delete manual booking row ${rowNumber}?`)) return;
      const body = new URLSearchParams({ action: "deleteBooking", rowNumber: String(rowNumber) });
      const res = await fetch(WRITE_URL, { method: "POST", body });
      const text = await res.text();

      if (!String(text).startsWith("OK")) {
        console.error(text);
        return toast(text || "Delete failed", 4500);
      }

      toast("Deleted ✅", 1500);
      await loadAll(false);
    }

    // ====== HELPER FUNCTIONS FOR DATA CONDENSATION ======
    function normKey(s) {
      return String(s || "").trim().toLowerCase();
    }

    function uniq(arr) {
      return Array.from(new Set((arr || []).map((x) => String(x || "").trim()).filter(Boolean)));
    }

    
    // ====== SWIMMING POOL (dashboard-style) CONDENSE ======
    // Groups Aqua Duck and Learn to Swim stages into single cards per day (ignores time differences).
    function condenseSwimmingPoolDashboardOnly(items) {
      const out = [];
      const rest = [];
      const groups = new Map();

      const clean = (s) => String(s || "").trim();

      const normTime = (t) => {
        const s = String(t || "").trim();
        const m = /^(\d{1,2}):(\d{2})/.exec(s);
        if (!m) return s;
        return `${String(m[1]).padStart(2, "0")}:${m[2]}`;
      };

      const timeToMin = (t) => {
        const m = /^(\d{1,2}):(\d{2})$/.exec(String(t || "").trim());
        if (!m) return null;
        return (parseInt(m[1], 10) * 60) + parseInt(m[2], 10);
      };

      function addToGroup(key, b, groupType, label) {
        const start = normTime(b.start);
        const end = normTime(b.end);
        const sMin = timeToMin(start);
        const eMin = timeToMin(end);

        if (!groups.has(key)) {
          groups.set(key, {
            ...b,
            start,
            end,
            _groupType: groupType, // "aquduck" | "lts"
            _labels: new Set(),
            _areas: new Set(),
            _notes: new Set(),
            _minStart: sMin,
            _maxEnd: eMin,
          });
        }

        const g = groups.get(key);
        if (label) g._labels.add(label);

        // Keep earliest start / latest end
        if (sMin !== null && (g._minStart == null || sMin < g._minStart)) {
          g._minStart = sMin;
          g.start = start;
        }
        if (eMin !== null && (g._maxEnd == null || eMin > g._maxEnd)) {
          g._maxEnd = eMin;
          g.end = end;
        }

        const area = clean(b.area);
        if (area) g._areas.add(area);

        const notes = clean(b.notes);
        if (notes) g._notes.add(notes);
      }

      for (const b of (items || [])) {
        const venue = clean(b.venue).toLowerCase();
        const name = clean(b.name);
        const nameLower = name.toLowerCase();

        if (!venue.includes("swimming")) {
          rest.push(b);
          continue;
        }

        // Aqua Duck (e.g. "Aqua Duck (1, 2, 3, 6)")
        if (nameLower.includes("aqua duck")) {
          const labelMatch = name.match(/\(([^\)]+)\)/);
          const label = labelMatch ? labelMatch[1].trim() : "";
          const key = `pool|${clean(b.date)}|aquduck`;
          addToGroup(key, b, "aquduck", label);
          continue;
        }

        // Stages (Stage 1, Stage 3A, Stage 13/14)
        const stageMatch = name.match(/^Stage\s*([0-9]+(?:\/[0-9]+)?[A-Za-z]?)\b/i);
        if (stageMatch) {
          const label = stageMatch[1].toUpperCase();
          const key = `pool|${clean(b.date)}|lts`;
          addToGroup(key, b, "lts", label);
          continue;
        }

        out.push(b);
      }

      for (const g of groups.values()) {
        const labels = Array.from(g._labels).filter(Boolean);
        labels.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

        if (g._groupType === "aquduck") {
          g.name = labels.length ? `Aqua Duck (${labels.join(", ")})` : "Aqua Duck";
        } else if (g._groupType === "lts") {
          g.name = labels.length ? `Learn to Swim (Stage ${labels.join(", ")})` : "Learn to Swim";
        }

        const areas = Array.from(g._areas);
        areas.sort((a, b) => a.localeCompare(b));
        g.area = areas.join(" • ");

        const notes = Array.from(g._notes);
        notes.sort((a, b) => a.localeCompare(b));
        g.notes = notes.join(" • ");

        out.push(g);
      }

      return out.concat(rest);
    }

// ====== MERGE + RENDER ======
    function mergedForDate(dateStr) {
      const all = []
        .concat((manualBookings || []).map((b) => ({ ...b, source: "manual" })))
        .concat((pmBookings || []).map((b) => ({ ...b, source: "perfectmind" })));

      let filtered = all
        .filter((b) => String(b.date || "").trim() === dateStr)
        .filter((b) => b.venue);

      filtered = condenseSwimmingPoolDashboardOnly(filtered);
      return filtered;
    }

    /**
     * Group bookings that are the “same booking” but repeated for different areas.
     * Key = venue + start + end + name
     */
    function condenseBookings(list) {
      const map = new Map();

      list.forEach((b) => {
        const key = [
          normKey(b.venue),
          normKey(b.start),
          normKey(b.end),
          normKey(b.name),
        ].join("|");

        if (!map.has(key)) {
          map.set(key, { ...b, areas: [], notesList: [] });
        }

        const g = map.get(key);
        if (b.area) g.areas.push(b.area);
        if (b.notes) g.notesList.push(b.notes);

        // Keep rowNumbers for manual deletes if needed later
        if (b.source === "manual" && b.rowNumber) {
          g.rowNumbers = g.rowNumbers || [];
          g.rowNumbers.push(b.rowNumber);
        }
      });

      return Array.from(map.values()).map((g) => {
        const areas = uniq(g.areas);
        const notes = uniq(g.notesList).join(" • ");
        return {
          ...g,
          areaCombined: areas.join(", "),
          areasCount: areas.length,
          notesCombined: notes,
        };
      });
    }

    function render() {
      const dateStr = getSelectedDate();
      const allRaw = mergedForDate(dateStr);
      const all = condenseBookings(allRaw);

      // group by venue
      const byVenue = {};
      VENUES.forEach((v) => (byVenue[v] = []));

      all.forEach((b) => {
        const v = b.venue;
        if (!byVenue[v]) byVenue[v] = [];
        byVenue[v].push(b);
      });

      Object.keys(byVenue).forEach((v) => {
        byVenue[v].sort((a, b) => toMin(a.start) - toMin(b.start) || toMin(a.end) - toMin(b.end));
      });

      // info line
      const info = document.getElementById("sourceInfo");
      const manualCount = all.filter((x) => x.source === "manual").length;
      const pmCount = all.filter((x) => x.source === "perfectmind").length;
      info.textContent =
        `Showing ${all.length} bookings • Manual ${manualCount} • PerfectMind ${pmCount}` +
        (lastPerfectMindFile ? ` • Latest CSV: ${lastPerfectMindFile}` : "");

      // render venue cards
      const wrap = document.getElementById("venueWrap");
      wrap.innerHTML = "";

      const venuesWithBookings = VENUES
        .map((v) => {
          const items = byVenue[v] || [];
          return { venue: v, items, score: venueBusynessScore(items) };
        })
        .filter((x) => x.items.length > 0)
        .sort((a, b) => b.score - a.score);

      venuesWithBookings.forEach(({ venue, items }) => {
        wrap.innerHTML += renderVenueCard(venue, items);
      });

      if (!venuesWithBookings.length) {
        wrap.innerHTML = `
          <div class="bg-card border border-line rounded-2xl p-4 text-sm font-black text-muted">
            No bookings today in this location.
          </div>
        `;
      }
    }

    function renderVenueCard(venue, items) {
      return `
        <div class="bg-card border border-line rounded-2xl p-3">
          <div class="flex items-center justify-between gap-2">
            <div class="font-black text-base">${escapeHtml(venue)}</div>
            <div class="text-xs font-extrabold text-muted">${items.length} booking(s)</div>
          </div>

          <div class="mt-2
            columns-1 md:columns-3 xl:columns-4
            [column-gap:0.75rem] [column-fill:auto]
            md:overflow-y-auto xl:overflow-y-hidden
            xl:h-[calc(100vh-220px)]">
            ${items.length ? items.map(renderBookingRow).join("") : `<div class="text-xs font-extrabold text-muted italic">No bookings</div>`}
          </div>
        </div>
      `;
    }

    function parseHM(t) {
      const m = /^(\d{1,2}):(\d{2})$/.exec(String(t || "").trim());
      if (!m) return null;
      return { h: parseInt(m[1], 10), m: parseInt(m[2], 10) };
    }

    function durationMins(start, end) {
      const s = parseHM(start), e = parseHM(end);
      if (!s || !e) return 0;
      return Math.max(0, (e.h * 60 + e.m) - (s.h * 60 + s.m));
    }

    function venueBusynessScore(items) {
      const count = items.length;
      const mins = items.reduce((sum, b) => sum + durationMins(b.start, b.end), 0);
      return (count * 10000) + mins;
    }

    function renderBookingRow(b) {
      const bookingName = (() => {
        const name = String(b.name || "").trim();
        const m = name.match(/^Stage\s*(\d+)/i);
        if (m) return `Learn to Swim – Stage ${m[1]}`;
        return name || "Booking";
      })();

      const srcPill = b.source === "perfectmind"
        ? ``
        : `<span class="rounded-full px-2.5 py-1 text-[11px] font-black bg-teal text-white">Manual</span>`;

      const deleteBtn = (b.source === "manual" && b.rowNumber)
        ? `<button class="rounded-xl px-3 py-2 font-black text-white bg-bad" type="button" onclick="deleteManual(${b.rowNumber})">Delete</button>`
        : "";

      const area = (b.areaCombined || b.area || "").trim();
      const notes = (b.notesCombined || b.notes || "").trim();

      // Status styling (only meaningful for today)
      const today = new Date();
      const todayISO = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
      const selectedISO = normalizeDate(getSelectedDate());
      const nowMin = (today.getHours() * 60) + today.getMinutes();

      const sMin = toMin(b.start);
      const eMin = toMin(b.end);

      let status = "upcoming";
      let soon = false;

      if (selectedISO && selectedISO < todayISO) {
        status = "past";
      } else if (selectedISO && selectedISO > todayISO) {
        status = "upcoming";
      } else if (selectedISO === todayISO && Number.isFinite(sMin) && Number.isFinite(eMin)) {
        if (nowMin > eMin) {
          status = "past";
        } else if (nowMin >= sMin && nowMin <= eMin) {
          status = "ongoing";
        } else {
          status = "upcoming";
          const minsToStart = sMin - nowMin;
          if (minsToStart > 0 && minsToStart <= 30) soon = true;
        }
      }

      const statusClass = status === "past" ? "is-past" : (status === "ongoing" ? "is-ongoing" : "");
      const statusPill = status === "ongoing"
        ? `<span class="status-pill now">Now</span>`
        : (status === "past"
          ? `<span class="status-pill done">Done</span>`
          : (soon ? `<span class="status-pill soon">Starting soon</span>` : ""));

      return `
        <div class="no-break booking-row bookingRow border border-line rounded-2xl bg-[#06181f] p-2.5 ${statusClass}">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-black text-[15px]">
                ${escapeHtml(b.start)}–${escapeHtml(b.end)} • ${escapeHtml(bookingName)}
              </div>

              <div class="text-xs font-extrabold text-muted mt-1 leading-snug">
                ${area ? `Area: ${escapeHtml(area)}${b.areasCount > 1 ? ` <span class="opacity-80">(${b.areasCount} areas)</span>` : ""}` : `&nbsp;`}
                ${notes ? `<div class="mt-1">Notes: ${escapeHtml(notes)}</div>` : ""}
              </div>
            </div>

            <div class="flex flex-col items-end gap-2 shrink-0">
              ${statusPill}
              ${srcPill}
              ${deleteBtn}
            </div>
          </div>
        </div>
      `;
    }

    async function loadAll(showToast) {
      try {
        if (showToast) toast("Loading…", 1200);
        await Promise.all([loadManual(), loadPerfectMind()]);
        render();
        if (showToast) toast("Loaded ✅", 1200);
      } catch (e) {
        console.error(e);
        toast("Load failed (check script / folder ID)", 3500);
        render();
      }
    }

    // ====== BOOT ======
    (function boot() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      document.getElementById("datePick").value = `${yyyy}-${mm}-${dd}`;
      loadAll(true);
    })();
  </script>
</body>
</html>
