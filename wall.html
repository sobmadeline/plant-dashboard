<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BRAC Tools - Wall Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pindan: "#C54B00",
            darkturq: "#004153",
            bg: "#07141a",
            card: "#0b2028",
            line: "#14313b",
            muted: "#cbd5e1",
            redx: "#b91c1c",
            amberx:"#ca8a04",
            greenx:"#15803d",
            bluex:"#2563eb"
          }
        }
      }
    }
  </script>
</head>

<body class="m-0 font-sans bg-bg text-slate-50">
  <header class="bg-darkturq px-5 py-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3.5">
      <div class="w-[46px] h-[46px] rounded-xl bg-pindan text-white flex items-center justify-center font-black tracking-wide">LOGO</div>
      <div>
        <div class="text-[22px] font-black">LIVE PLANT STATUS</div>
        <div class="text-sm opacity-85 mt-0.5">Aquatic Facility – 25m Pool</div>
      </div>
    </div>
    <div class="text-sm font-bold text-muted text-right leading-snug">
      <div id="lastUpdated">Last updated: —</div>
      <div id="refreshedAt">Refreshed: —</div>
    </div>
  </header>

  <div class="px-5 pt-4 pb-3">
    <!-- Top tiles -->
    <section class="grid grid-cols-4 gap-3 mb-4 max-[1000px]:grid-cols-2">
      <div class="rounded-2xl border border-line bg-card p-4 min-h-[92px] flex flex-col justify-between"
           style="background: linear-gradient(0deg, rgba(185,28,28,.25), rgba(185,28,28,.25)), #0b2028;">
        <div class="text-[13px] text-muted font-black tracking-widest">OFFLINE</div>
        <div class="text-[34px] font-black" id="cntOffline">—</div>
      </div>

      <div class="rounded-2xl border border-line bg-card p-4 min-h-[92px] flex flex-col justify-between"
           style="background: linear-gradient(0deg, rgba(202,138,4,.25), rgba(202,138,4,.25)), #0b2028;">
        <div class="text-[13px] text-muted font-black tracking-widest">DEGRADED</div>
        <div class="text-[34px] font-black" id="cntDegraded">—</div>
      </div>

      <div class="rounded-2xl border border-line bg-card p-4 min-h-[92px] flex flex-col justify-between"
           style="background: linear-gradient(0deg, rgba(37,99,235,.22), rgba(37,99,235,.22)), #0b2028;">
        <div class="text-[13px] text-muted font-black tracking-widest">PLANNED</div>
        <div class="text-[34px] font-black" id="cntPlanned">—</div>
      </div>

      <div class="rounded-2xl border border-line bg-card p-4 min-h-[92px] flex flex-col justify-between"
           style="background: linear-gradient(0deg, rgba(21,128,61,.25), rgba(21,128,61,.25)), #0b2028;">
        <div class="text-[13px] text-muted font-black tracking-widest">OPERATIONAL</div>
        <div class="text-[34px] font-black" id="cntOperational">—</div>
      </div>
    </section>

    <!-- Handover banner -->
    <div id="handoverBanner"
         class="hidden my-3 rounded-2xl border border-pindan bg-pindan/15 p-3 font-black leading-snug">
      HANDOVER ACTIVE: <span id="handoverMsg"></span>
      <div id="handoverMeta" class="text-xs font-extrabold text-muted mt-1.5"></div>
    </div>

    <!-- Bottom -->
    <section class="grid grid-cols-[2fr_1.2fr] gap-3 items-start max-[1000px]:grid-cols-1">
      <div class="rounded-2xl border border-line bg-card overflow-hidden">
        <div class="px-4 py-3 bg-[#071d24] border-b border-line flex items-center justify-between gap-2">
          <div class="text-[13px] text-muted font-black tracking-widest uppercase">Status by system</div>
          <div class="text-xs text-muted opacity-90 font-extrabold">Worst status shown per system</div>
        </div>
        <div id="systems" class="grid grid-cols-2 gap-3 p-3 max-[1000px]:grid-cols-1"></div>
      </div>

      <div class="rounded-2xl border border-line bg-card overflow-hidden">
        <div class="px-4 py-3 bg-[#071d24] border-b border-line flex items-center justify-between gap-2">
          <div class="text-[13px] text-muted font-black tracking-widest uppercase">Noticeboard</div>
          <div class="text-xs text-muted opacity-90 font-extrabold">Short operational notices</div>
        </div>
        <div id="notices" class="p-3 flex flex-col gap-2.5"></div>
      </div>
    </section>
  </div>

  <footer class="px-5 pb-4 text-xs font-extrabold text-muted opacity-90 flex justify-between gap-2">
    <div>Broome Recreation and Aquatic Centre Internal Operations Dashboard</div>
    <div>Shire of Broome</div>
  </footer>

<script>
  const PLANT_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=0&single=true&output=csv";

  const NOTICE_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=684780974&single=true&output=csv";

  const HANDOVER_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg5Y7GWAhMmpNHxvGOORvfm9v5RTD2PfPrRaljFs9yPmf8uosPuWVzkBfm1tm0njRwvQ40ukJa4ZL1/pub?gid=871823190&single=true&output=csv";

  const REFRESH_MS = 5000;

  function fmtTime(d){
    return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function parseCSV(text){
    const rows = [];
    let row = [], cur = "", inQuotes = false;

    for (let i=0; i<text.length; i++){
      const c = text[i];
      const next = text[i+1];

      if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
      if (c === '"') { inQuotes = !inQuotes; continue; }

      if (!inQuotes && c === ',') { row.push(cur); cur=""; continue; }
      if (!inQuotes && (c === '\n' || c === '\r')) {
        if (c === '\r' && next === '\n') i++;
        row.push(cur); cur="";
        if (row.some(v => v !== "")) rows.push(row);
        row = [];
        continue;
      }
      cur += c;
    }
    row.push(cur);
    if (row.some(v => v !== "")) rows.push(row);
    return rows;
  }

  function normStatus(s){
    s = String(s || "").trim().toLowerCase();
    if (s === "offline") return "Offline";
    if (s === "degraded") return "Degraded";
    if (s === "planned maintenance") return "Planned Maintenance";
    return "Operational";
  }

  function statusRank(s){
    s = normStatus(s);
    if (s === "Offline") return 1;
    if (s === "Degraded") return 2;
    if (s === "Planned Maintenance") return 3;
    return 4;
  }

  function systemKeyFromRow(row){
    const sys = (row.system || "").trim().toLowerCase();
    if (sys === "pump" || sys === "pumps") return "PUMPS";
    if (sys === "filtration" || sys === "filters") return "FILTERS";
    if (sys === "heating") return "HEATING";
    if (sys === "disinfection" || sys === "uv") return "DISINFECTION";

    const id = (row.id || "").trim().toUpperCase();
    if (id.startsWith("PUMP")) return "PUMPS";
    if (id.startsWith("FIL")) return "FILTERS";
    if (id.startsWith("HEAT")) return "HEATING";
    if (id.startsWith("UV")) return "UV";
    return "OTHER";
  }

  function prettySystemName(key){
    const k = String(key || "").toUpperCase();
    if (k === "PUMPS") return "PUMPS";
    if (k === "FILTERS") return "FILTERS";
    if (k === "HEATING") return "HEATING";
    if (k === "UV") return "UV";
    if (k === "DISINFECTION") return "DISINFECTION";
    return k || "OTHER";
  }

  function badgeClasses(status){
    const s = normStatus(status);
    const base = "font-black text-xs px-2.5 py-1 rounded-full border border-line tracking-wide";
    if (s === "Offline") return base + " bg-redx/25 text-red-200";
    if (s === "Degraded") return base + " bg-amberx/25 text-amber-200";
    if (s === "Planned Maintenance") return base + " bg-bluex/20 text-blue-200";
    return base + " bg-greenx/25 text-green-200";
  }

  function dotClasses(status){
    const s = normStatus(status);
    const base = "w-3 h-3 rounded-full border border-line flex-none";
    if (s === "Offline") return base + " bg-redx";
    if (s === "Degraded") return base + " bg-amberx";
    if (s === "Planned Maintenance") return base + " bg-bluex";
    return base + " bg-greenx";
  }

  function isActiveNotice(startStr, endStr){
    const now = new Date();
    const start = startStr ? new Date(startStr) : null;
    const end = endStr ? new Date(endStr) : null;
    const okStart = !startStr || (!isNaN(start) && start <= now);
    const okEnd = !endStr || (!isNaN(end) && end >= now);
    return okStart && okEnd;
  }

  async function loadPlant(){
    const res = await fetch(PLANT_CSV_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("Plant CSV fetch failed: " + res.status);
    const csv = await res.text();
    const data = parseCSV(csv);

    const headers = data[0];
    const idx = (n) => headers.indexOf(n);

    const iId = idx("Component ID");
    const iName = idx("Component Name");
    const iSystem = idx("System");
    const iStatus = idx("Status");
    const iUpdated = idx("Last Updated");

    const items = data.slice(1).map(r => ({
      id: (r[iId] || "").trim(),
      name: (r[iName] || "").trim(),
      system: (r[iSystem] || "").trim(),
      status: normStatus(r[iStatus]),
      updated: (r[iUpdated] || "").trim()
    })).filter(x => x.id && x.name);

    const counts = { Offline:0, Degraded:0, Planned:0, Operational:0 };
    let maxUpdated = null;

    for (const it of items){
      if (it.status === "Offline") counts.Offline++;
      else if (it.status === "Degraded") counts.Degraded++;
      else if (it.status === "Planned Maintenance") counts.Planned++;
      else counts.Operational++;

      const dt = new Date(it.updated);
      if (!isNaN(dt) && (!maxUpdated || dt > maxUpdated)) maxUpdated = dt;
    }

    document.getElementById("cntOffline").textContent = counts.Offline;
    document.getElementById("cntDegraded").textContent = counts.Degraded;
    document.getElementById("cntPlanned").textContent = counts.Planned;
    document.getElementById("cntOperational").textContent = counts.Operational;

    document.getElementById("lastUpdated").textContent =
      "Last updated: " + (maxUpdated ? fmtTime(maxUpdated) : "—");

    const groups = new Map();
    for (const it of items){
      const key = systemKeyFromRow(it);
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(it);
    }

    const order = ["PUMPS", "FILTERS", "HEATING", "UV", "DISINFECTION", "OTHER"];
    const container = document.getElementById("systems");
    container.innerHTML = "";

    for (const key of order){
      if (!groups.has(key)) continue;
      const list = groups.get(key);

      let worst = "Operational";
      for (const it of list){
        if (statusRank(it.status) < statusRank(worst)) worst = it.status;
      }

      list.sort((a,b) => statusRank(a.status) - statusRank(b.status) || a.name.localeCompare(b.name));

      const card = document.createElement("div");
      card.className = "rounded-2xl border border-line bg-[#06181f] p-3 min-h-[140px] flex flex-col gap-2.5";
      card.innerHTML = `
        <div class="flex items-center justify-between gap-2.5">
          <div class="font-black text-lg tracking-wide">${escapeHtml(prettySystemName(key))}</div>
          <span class="${badgeClasses(worst)}">${escapeHtml(worst.toUpperCase())}</span>
        </div>
        <div class="flex flex-col gap-2">
          ${list.map(it => `
            <div class="flex items-center justify-between gap-2.5">
              <div class="flex items-center gap-2.5 min-w-0">
                <span class="${dotClasses(it.status)}"></span>
                <span class="font-black text-sm whitespace-nowrap overflow-hidden text-ellipsis">${escapeHtml(it.name)}</span>
              </div>
            </div>
          `).join("")}
        </div>
      `;
      container.appendChild(card);
    }
  }

  async function loadNotices(){
    const res = await fetch(NOTICE_CSV_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("Notice CSV fetch failed: " + res.status);
    const csv = await res.text();
    const data = parseCSV(csv);
    const headers = data[0];
    const idx = (n) => headers.indexOf(n);

    const iTitle = idx("Title");
    const iMsg = idx("Message");
    const iCat = idx("Category");
    const iStart = idx("Start");
    const iEnd = idx("End");

    const items = data.slice(1).map(r => ({
      title: (r[iTitle] || "").trim(),
      msg: (r[iMsg] || "").trim(),
      cat: (r[iCat] || "").trim(),
      start: (r[iStart] || "").trim(),
      end: (r[iEnd] || "").trim(),
    })).filter(x => x.title || x.msg);

    const active = items.filter(n => isActiveNotice(n.start, n.end)).slice(0, 6);

    const container = document.getElementById("notices");
    container.innerHTML = "";

    const noticeShell = (tagStyle, title, msg, meta) => `
      <div class="rounded-2xl border border-line bg-[#06181f] p-3 flex gap-3">
        <div class="w-2.5 rounded-lg" style="${tagStyle}"></div>
        <div class="min-w-0 flex flex-col gap-1">
          <div class="font-black text-sm tracking-wide">${title}</div>
          <div class="text-sm font-extrabold text-muted leading-snug">${msg}</div>
          <div class="text-[11px] font-extrabold text-muted opacity-85">${meta}</div>
        </div>
      </div>
    `;

    if (!active.length){
      container.innerHTML = noticeShell(
        "background:#C54B00;",
        "No active notices",
        "Nothing currently posted.",
        "Notice"
      );
      return;
    }

    for (const n of active){
      const cat = (n.cat || "Notice").trim();
      let tag = "background:#C54B00;";
      if (cat.toLowerCase() === "safety") tag = "background:#b91c1c;";
      if (cat.toLowerCase() === "ops") tag = "background:#ca8a04;";
      if (cat.toLowerCase() === "info") tag = "background:#2563eb;";

      container.innerHTML += noticeShell(
        tag,
        escapeHtml(n.title || cat),
        escapeHtml(n.msg),
        escapeHtml(cat) + (n.end ? " • Ends: " + escapeHtml(n.end) : "")
      );
    }
  }

  async function loadHandover(){
    const res = await fetch(HANDOVER_CSV_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("Handover CSV fetch failed: " + res.status);
    const csv = await res.text();
    const data = parseCSV(csv);
    const headers = data[0];
    const row = data[1] || [];
    const idx = (n) => headers.indexOf(n);

    const active = (row[idx("Active")] || "").trim().toLowerCase();
    const msg = (row[idx("Message")] || "").trim();
    const created = (row[idx("Created")] || "").trim();
    const ack = (row[idx("Acknowledged")] || "").trim().toLowerCase();

    const banner = document.getElementById("handoverBanner");

    if (active === "yes" && ack !== "yes" && msg){
      document.getElementById("handoverMsg").textContent = msg;
      document.getElementById("handoverMeta").textContent = created ? ("Created: " + created) : "";
      banner.classList.remove("hidden");
    } else {
      banner.classList.add("hidden");
    }
  }

  async function tick(){
    try{
      await Promise.all([loadPlant(), loadNotices(), loadHandover()]);
      document.getElementById("refreshedAt").textContent = "Refreshed: " + fmtTime(new Date());
    } catch(e){
      console.error(e);
      document.getElementById("refreshedAt").textContent = "Refreshed: ERROR";
    }
  }

  tick();
  setInterval(tick, REFRESH_MS);
</script>
</body>
</html>
